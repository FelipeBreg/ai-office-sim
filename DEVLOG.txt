================================================================================
  AI OFFICE SIM — DEVELOPMENT LOG
  Repository: https://github.com/FelipeBreg/ai-office-sim
  Roadmap: ProjectA_Development_Roadmap.html (246 tasks, 50 epics, 6 phases)
  Generated by: Claude Opus 4.6 (AI pair programmer)
================================================================================


================================================================================
COMMIT #1 — Epic P0-1: Monorepo & Project Scaffolding
================================================================================
Hash:     9f3beec55be0c08b2c4c675cfa63a34c42a30f0b
Date:     2026-02-24 17:46:38 -0300
Tasks:    P0-1.1 through P0-1.7 (7 tasks)
================================================================================

WHAT WAS BUILT:
  - Root monorepo with Turborepo + pnpm workspaces
  - turbo.json with pipelines: build, dev, lint, typecheck, test, clean
  - apps/web: Next.js 15, App Router, Tailwind CSS v4, Turbopack
    - Directory structure for all 11 screens under [locale]/(auth)/
    - globals.css with 24 design system CSS tokens
    - IBM Plex Mono font via next/font/google
    - PostCSS config for Tailwind v4
  - apps/worker: Node.js TypeScript service
    - HTTP health endpoint on port 4000
    - Graceful SIGTERM shutdown
    - tsx for dev hot-reload
  - packages/db: Drizzle ORM (schema, migrations, client, seed scripts)
  - packages/api: tRPC with superjson transformer, publicProcedure, root router
  - packages/shared: TypeScript types, Zod schemas, constants, utilities
  - packages/ai: Agent engine package (stub, populated in P0-6/P0-7)
  - packages/queue: BullMQ queue definitions (stub, populated in P0-3)
  - packages/realtime: Socket.IO event types (stub, populated in P0-9)
  - packages/tsconfig: Shared configs (base, nextjs, node, library)
  - packages/eslint-config: Shared ESLint configs (base, next, node)
  - docker-compose.yml: PostgreSQL 16 (pgvector image) + Redis 7-alpine
  - .env.example with all 11 required environment variables
  - Prettier config (.prettierrc + .prettierignore)
  - .gitignore, .npmrc

FILES CREATED (64 files):
  Root:
    .env.example, .gitignore, .npmrc, .prettierignore, .prettierrc,
    docker-compose.yml, package.json, pnpm-lock.yaml, pnpm-workspace.yaml,
    turbo.json
  apps/web:
    .eslintrc.cjs, next.config.mjs, package.json, postcss.config.mjs,
    tsconfig.json, src/app/globals.css, src/app/layout.tsx, src/app/page.tsx
  apps/worker:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/db:
    .eslintrc.cjs, drizzle.config.ts, package.json, tsconfig.json,
    src/client.ts, src/index.ts, src/schema/index.ts
  packages/api:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts, src/root.ts,
    src/trpc.ts
  packages/shared:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts,
    src/types/index.ts, src/constants/index.ts, src/schemas/index.ts,
    src/utils/index.ts
  packages/ai:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/queue:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/realtime:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/tsconfig:
    package.json, base.json, library.json, nextjs.json, node.json
  packages/eslint-config:
    package.json, base.js, next.js, node.js

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. .eslintrc.js used CJS syntax (module.exports) in ESM packages ("type":"module")
       → Renamed all 7 files to .eslintrc.cjs
    2. Font-family in globals.css used literal 'IBM Plex Mono' instead of CSS var
       → Changed to var(--font-family-mono) referencing var(--font-mono) from next/font
    3. Missing --font-family-mono in @theme block, so Tailwind font-mono utility broken
       → Added --font-family-mono to @theme

  MEDIUM (6):
    4. next.config.js and postcss.config.js used ESM export without "type":"module"
       → Renamed both to .mjs
    5. --spacing-* tokens in wrong Tailwind v4 namespace
       → Moved to --width-* and --height-* namespaces
    6. Duplicate bullmq + ioredis in both worker and queue packages
       → Removed from worker, consumed through @ai-office/queue only
    7. 26 CSS tokens instead of spec's 24 (duplicate risk/status colors)
       → Removed 3 duplicate risk tokens, kept only --color-risk-critical
    8. Hardcoded lang="pt-BR" in layout (will be dynamic with i18n)
       → Noted for P0-8 fix
    9. Non-null assertion (!) on DATABASE_URL in drizzle.config.ts
       → Added runtime check with clear error message

  MINOR (3):
    10. Missing explicit outputs:[] in turbo lint/typecheck/test tasks → Added
    11. Missing eslint-config-next peer dependency → Added as optional
    12. Aggressive * { border-radius: 0 !important } → Replaced with --radius-* tokens

VERIFICATION:
  - pnpm install: zero errors across 11 workspaces
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Design system: 24 CSS tokens confirmed


================================================================================
COMMIT #2 — Epic P0-2: PostgreSQL & Drizzle ORM Setup
================================================================================
Hash:     12b302d05673b6c166451fc94e6c819216b31b8a
Date:     2026-02-24 17:56:18 -0300
Tasks:    P0-2.1 through P0-2.9 (9 tasks; P0-2.10 Supabase RLS deferred to staging)
================================================================================

WHAT WAS BUILT:
  15 database tables across 10 schema files:
    - organizations: uuid PK, name, slug (unique), clerk_org_id, plan enum
    - users: uuid PK, clerk_user_id (unique), email, name, locale, role enum, org FK
    - projects: uuid PK, org FK, name, slug, color, composite unique (org_id, slug)
    - agents: uuid PK, project FK, name, archetype/status/trigger enums, config jsonb,
              tools text[], system prompts (EN+PT-BR), unique (project_id, slug)
    - agent_memory: uuid PK, agent FK, project FK, key/value, embedding vector(1536)
    - action_logs: uuid PK, project FK, agent FK, session_id, action_type, tokens,
                   cost, duration, composite index (project_id, created_at)
    - approvals: uuid PK, project FK, agent FK, action_log FK, risk_level enum,
                 status enum, reviewed_by FK (nullable)
    - workflows: uuid PK, project FK, name, definition jsonb (React Flow graph)
    - workflow_runs: uuid PK, workflow FK, project FK, status enum
    - workflow_node_runs: uuid PK, run FK, project FK, node_id, agent FK
    - documents: uuid PK, project FK, title, source_type enum, content
    - document_chunks: uuid PK, document FK, project FK, embedding vector(1536)
    - strategies: uuid PK, project FK, type enum, user_draft, ai_refined, status enum
    - strategy_kpis: uuid PK, strategy FK, project FK, current/target values
    - strategy_learnings: uuid PK, strategy FK, project FK, agent FK, insight

  Supporting files:
    - custom-types.ts: pgvector vector(1536) custom Drizzle type
    - enums.ts: 16 PostgreSQL enums (plan, user_role, locale, agent_archetype,
                agent_status, trigger_type, memory_scope, action_status, risk_level,
                approval_status, workflow_run_status, document_source_type,
                strategy_type, strategy_status, kpi_direction)
    - seed.ts: Idempotent seed script creating 1 org, 1 user, 1 project,
               3 agents (Support/Sales/Data Analyst with PT-BR prompts),
               5 action log entries

FILES CREATED (12 new, 1 modified):
  packages/db/src/schema/:
    custom-types.ts, enums.ts, organizations.ts, users.ts, projects.ts,
    agents.ts, action-logs.ts, approvals.ts, workflows.ts, documents.ts,
    strategies.ts
  packages/db/src/:
    seed.ts
  Modified:
    packages/db/src/schema/index.ts (barrel export updated)

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (4):
    1. projects.slug had no unique constraint → seed onConflictDoNothing silently failed
       → Added composite unique index (org_id, slug)
    2. Seed project used onConflictDoNothing (returns empty on conflict)
       → Changed to onConflictDoUpdate so .returning() always returns the row
    3. Agents inserted with plain insert (no upsert, duplicates on re-run)
       → Added unique (project_id, slug) + seed now uses onConflictDoUpdate
    4. Action logs inserted with plain insert (duplicates on re-run)
       → Added guard: check existing logs for project before inserting

  MEDIUM (3):
    5. workflow_node_runs missing project_id FK (every child table needs it for RLS)
       → Added project_id FK with cascade delete
    6. strategy_kpis missing createdAt timestamp (every other table has it)
       → Added createdAt with defaultNow()
    7. Redundant org_slug_idx index (slug already has .unique() which creates index)
       → Removed the redundant explicit index

  MINOR (1):
    8. users table missing updatedAt (mutable fields: role, locale, timezone)
       → Added updatedAt with $onUpdate

  ALSO FIXED DURING CODING (before review):
    - Missing jsonb import in approvals.ts
    - vector custom type fromDriver param typed as string instead of unknown
    - Duplicate vector type definition in agents.ts and documents.ts
      → Extracted to shared custom-types.ts

VERIFICATION:
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Table count: 15 confirmed
  - Seed idempotency: org+user use onConflictDoUpdate, project uses onConflictDoUpdate
    with composite target, agents use onConflictDoUpdate, logs guarded with SELECT


================================================================================
COMMIT #3 — Epic P0-3: Redis & BullMQ Queue System
================================================================================
Hash:     f528052
Date:     2026-02-24 ~18:20 -0300
Tasks:    P0-3.1 through P0-3.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  packages/queue/src/:
    - connection.ts: BullMQ connection options factory (parses REDIS_URL,
      includes db index, enableReadyCheck, maxRetriesPerRequest)
    - jobs.ts: 7 Zod schemas for typed job payloads (AgentExecution,
      AgentScheduled, ToolExecution, EmbeddingGeneration, Notification,
      Analytics, Cleanup)
    - queues.ts: 7 BullMQ queue instances as lazy singletons with
      per-queue retry/backoff config + removeOnFail:false (dead letter)
    - index.ts: Barrel export (QUEUE_NAMES, getters, schemas, types)

  apps/worker/src/:
    - workers/create-worker.ts: Generic typed worker factory with
      Zod validation, error/completed/failed/stalled handlers
    - workers/*.worker.ts: 7 stub workers using factory pattern
    - index.ts: Express server + Bull Board (dev) + health endpoint
      + graceful shutdown with 30s timeout + global error handlers

  Queue architecture (7 queues):
    agent-execution:   concurrency=5,  retry=3x 30s exp backoff
    agent-scheduled:   concurrency=3,  retry=3x 30s exp backoff
    tool-execution:    concurrency=10, retry=5x 10s exp backoff
    embedding-generation: concurrency=3, retry=3x 15s exp backoff
    notification:      concurrency=5,  retry=5x 60s exp backoff
    analytics:         concurrency=1,  retry=3x 60s exp backoff
    cleanup:           concurrency=1,  retry=2x 120s exp backoff

FILES CREATED (11 new, 4 modified):
  New:
    packages/queue/src/connection.ts, jobs.ts, queues.ts
    apps/worker/src/workers/create-worker.ts
    apps/worker/src/workers/{agent-execution,agent-scheduled,tool-execution,
      embedding-generation,notification,analytics,cleanup}.worker.ts
    apps/worker/src/workers/index.ts
  Modified:
    packages/queue/src/index.ts, packages/queue/package.json
    apps/worker/src/index.ts, apps/worker/package.json, pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. Workers never validated job payloads with Zod at runtime
       → Created createTypedWorker factory with schema.parse() on every job
    2. getConnectionOptions() missing enableReadyCheck:false (race on reconnect)
       → Added to connection options
    3. createRedisConnection() was a footgun (unused but exported, leaked connections)
       → Removed entirely, only getConnectionOptions() remains

  HIGH (2):
    4. Graceful shutdown could hang indefinitely (no timeout)
       → Added 30s hard-exit timeout + server.closeAllConnections()
    5. getConnectionOptions() dropped Redis db index from URL path
       → Added db: Number(parsed.pathname.slice(1)) parsing

  MEDIUM (1):
    6. No error event handlers on workers (could crash process)
       → Added worker.on('error') in the factory

  LOW (3) — also fixed:
    7. No unhandledRejection/uncaughtException handlers → Added
    8. 7 worker files were 250+ lines of boilerplate → Extracted factory (30 lines)
    9. Unused socket.io dep in worker → Removed (will add in P0-9)
    10. Unused @ai-office/shared dep in queue package → Removed

  ALSO FIXED DURING CODING (before review):
    - Missing zod dep in packages/queue/package.json
    - ioredis import: default vs named export issue with NodeNext resolution
      → Used named import { Redis } from 'ioredis'
    - bull-board adapter import path: .js extension not in exports map
      → Removed .js suffix
    - bullmq needed as direct dep in worker (Worker class import)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - pnpm install: zero errors across all workspaces
  - All 7 queues match roadmap concurrency and retry specs
  - All 7 workers validate payloads with Zod before processing


================================================================================
