================================================================================
  AI OFFICE SIM — DEVELOPMENT LOG
  Repository: https://github.com/FelipeBreg/ai-office-sim
  Roadmap: ProjectA_Development_Roadmap.html (246 tasks, 50 epics, 6 phases)
  Generated by: Claude Opus 4.6 (AI pair programmer)
================================================================================


================================================================================
COMMIT #60 — Reorganize Sidebar Nav Groups
================================================================================
DATE: 2026-02-27
HASH: 880589d
PHASE: Post-Phase 3 — Polish

WHAT CHANGED:
  - Reorganized sidebar navigation into 3 new groups (replacing Operations/
    Business/Configuration):
      1. Monitoring: Office, Approvals, Strategy, Analytics, Memory
      2. AI Capabilities: Agents, Workflows, Tools
      3. Sectors: DevOps, Finance
  - Atlas remains pinned at top with separator
  - Settings (config icon) remains pinned at bottom
  - Updated i18n group labels in en-US and pt-BR:
      en: "Monitoring", "AI Capabilities", "Sectors"
      pt: "Monitoramento", "IA & Capacidades", "Setores"

FILES: 3 changed
  - MODIFIED: apps/web/src/components/layout/sidebar.tsx
  - MODIFIED: apps/web/messages/en-US.json
  - MODIFIED: apps/web/messages/pt-BR.json

VERIFICATION:
  - tsc --noEmit: 0 errors

================================================================================

================================================================================
COMMIT #59 — 10-Feature Post-Phase 3 Enhancement Pack
================================================================================
DATE: 2026-02-27
HASH: (pending)
PHASE: Post-Phase 3 — Feature

WHAT CHANGED:
  SIDEBAR REORGANIZATION:
  - Replaced flat navItems array with 3 collapsible groups:
    Operations (Dashboard, Agents, Workflows, Analytics),
    Business (Strategy, Finance, Memory),
    Configuration (Tools)
  - Atlas pinned at top with visual separator
  - Settings pinned at bottom above collapse toggle
  - Group collapse state persisted in Zustand (ui-store collapsedGroups)

  FINANCE PAGE (NEW):
  - Full finance dashboard pulling real data from trpc.actionLogs.stats
  - Revenue Overview: 3 summary cards (total spend, tokens, actions)
  - Expense Tracking: cost-by-model table from action_logs
  - Daily Breakdown: day-by-day cost/token/action table
  - Period selector (7/30/90 days)
  - Placeholder Tax Obligations + Reports sections with Coming Soon badges

  ATLAS LIGHT MODE FIX:
  - atlas/page.tsx: all hardcoded hex colors → Tailwind CSS variable classes
  - OrbVisualization.tsx: reads --color-accent-cyan via getComputedStyle
    at runtime for canvas; MutationObserver on data-theme for live updates
  - TranscriptPanel.tsx: all rgba() inline styles → Tailwind opacity classes

  SETTINGS MODELS TAB:
  - 6th tab "Models" with Cpu icon
  - Default model selector (Sonnet 4.6 / Haiku 4.5 / Opus 4.6)
  - Token pricing table (input/output $/1M sourced from llm.ts constants)
  - Monthly budget cap input (stored in localStorage as interim)

  TOOLS UI UPDATES:
  - Built-in tools show "BUILT-IN" badge, no connect button
  - External tools show connection status + tutorial links
  - search_web description updated: "AI-powered web search with intelligent
    result extraction via Serper API (requires API key)"

  STRATEGY ENHANCEMENTS:
  - Insight strip renamed from "AI Insights" to "ATLAS Insights"
  - Added "Implement" button → navigates to /atlas?insight={learningId}
  - Added "Business Playbook" button → links to /docs
  - Added "Generate Insights" button (disabled, BullMQ cron TODO)

  ATLAS SUPER-INTELLIGENCE:
  - New tRPC router: atlas.chat mutation with real Anthropic LLM call
  - JARVIS-like system prompt with full company context awareness
    (agents, workflows, strategies injected into prompt)
  - Replaced mock simulateResponse() with live tRPC mutation
  - Conversation history (last 20 messages) sent for context
  - Action detection: parses [ACTION: type] patterns from LLM responses
  - Approval popups: inline cards in transcript with Approve/Reject buttons
  - Strategy integration: reads ?insight= query param, auto-sends to Atlas
  - atlas-store enhanced: pendingActions[], context, addAction/approve/reject

FILES CHANGED (16):
  Modified:
  - apps/web/src/components/layout/sidebar.tsx
  - apps/web/src/stores/ui-store.ts
  - apps/web/src/stores/atlas-store.ts
  - apps/web/src/app/[locale]/(auth)/atlas/page.tsx
  - apps/web/src/components/atlas/OrbVisualization.tsx
  - apps/web/src/components/atlas/TranscriptPanel.tsx
  - apps/web/src/app/[locale]/(auth)/settings/page.tsx
  - apps/web/src/app/[locale]/(auth)/tools/page.tsx
  - apps/web/src/app/[locale]/(auth)/strategy/page.tsx
  - apps/web/src/components/strategy/insight-strip.tsx
  - packages/api/src/root.ts
  - apps/web/messages/en-US.json
  - apps/web/messages/pt-BR.json

  New:
  - apps/web/src/app/[locale]/(auth)/finance/page.tsx
  - apps/web/src/components/atlas/ApprovalPopup.tsx
  - packages/api/src/routers/atlas.ts

TYPECHECK: 0 errors (web + api)
--------------------------------------------------------------------------------


================================================================================
COMMIT #58 — Tools Detail Panel + Analytics Dashboard + Workflow Card Improvements
================================================================================
DATE: 2026-02-27
HASH: ef31ac3
PHASE: Post-Phase 3 — Feature

WHAT CHANGED:
  TOOLS PAGE:
  - Refactored from flat grid → master/detail layout
  - Left: clickable category list with connection badges
  - Right: detail panel showing individual tools, approval flags, and
    tutorial links (WhatsApp, Email, Serper, RD Station, Google Sheets)
  - i18n: toolCount, selectApp, setupGuide, availableTools, close keys

  ANALYTICS PAGE:
  - New tRPC endpoint: actionLogs.stats (aggregated metrics over N days)
    → total actions, total tokens, total cost
    → daily breakdown (day, actions, tokens, cost)
    → cost by model (extracted from input->>'model' in llm_response logs)
  - Dashboard section at top of page: 3 stat cards + 2 charts
    → bar chart: daily action count (7 days, hover tooltips)
    → table: cost per model (Haiku/Sonnet/Opus) with tokens + USD
  - i18n: 7 new stats keys in en-US and pt-BR

  WORKFLOWS:
  - Workflow cards now show node-type indicator dots (colored 1.5px squares)
    using same NODE_TYPE_COLORS map as template cards
  - Agent count badge (Bot icon + "N agents") on both workflow and template cards
  - Shared extractNodeInfo() helper to parse definition JSON
  - i18n: agentCount key in both workflows and workflowTemplates namespaces

FILES CHANGED (7):
  apps/web/src/app/[locale]/(auth)/tools/page.tsx    — master/detail layout
  apps/web/src/app/[locale]/(auth)/analytics/page.tsx — metrics dashboard
  packages/api/src/routers/action-logs.ts            — stats endpoint
  apps/web/src/app/[locale]/(auth)/workflows/page.tsx — node dots + agent count
  apps/web/src/app/[locale]/(auth)/workflows/templates/page.tsx — agent count
  apps/web/messages/en-US.json                       — +12 i18n keys
  apps/web/messages/pt-BR.json                       — +12 i18n keys


================================================================================
COMMIT #57 — Light/Dark Mode Switcher
================================================================================
DATE: 2026-02-27
HASH: a3563b0
PHASE: Post-Phase 3 — Feature

WHAT CHANGED:
  - Light mode CSS variable overrides in globals.css: cream backgrounds (#FAF6F1),
    orange accent (#E07800), dark text (#1A1A1A) — status colors unchanged
  - Zustand UI store: added theme state ('dark'|'light'), toggleTheme(), setTheme()
    persisted to localStorage alongside sidebarCollapsed
  - ThemeProvider component: syncs data-theme attribute on <html> from store
  - Header: Sun/Moon toggle button (lucide-react) before locale switcher
  - Blocking <script> in layout.tsx prevents FOUC by reading localStorage before paint
  - not-found.tsx: replaced hardcoded hex colors with CSS variable references
  - i18n: lightMode/darkMode keys added for en-US and pt-BR

FILES CHANGED (9):
  apps/web/src/app/globals.css              — light mode CSS overrides
  apps/web/src/stores/ui-store.ts           — theme state + actions
  apps/web/src/components/layout/theme-provider.tsx — NEW, data-theme sync
  apps/web/src/components/layout/app-shell.tsx      — mount ThemeProvider
  apps/web/src/components/layout/header.tsx          — toggle button
  apps/web/src/app/[locale]/layout.tsx               — FOUC-prevention script
  apps/web/src/app/not-found.tsx                     — use CSS variables
  apps/web/messages/en-US.json              — +2 i18n keys
  apps/web/messages/pt-BR.json              — +2 i18n keys

KNOWN LIMITATIONS:
  - Many components still use hardcoded hex colors (TeamRoster, AgentInspectPanel,
    WorkflowEditor, etc.) — these won't respond to theme switch yet
  - 3D office scene (THREE.js) is inherently dark-themed, unaffected by toggle
  - Clerk UserButton not yet theme-aware
  - No 'system' preference option (manual toggle only)


================================================================================
COMMIT #56 — Workflow Template Gallery (12 Pre-built Templates)
================================================================================
DATE: 2026-02-27
HASH: 288e9a9
PHASE: Post-Phase 3 — Feature

WHAT CHANGED:
  - New DB schema: workflow_templates table (global, no projectId) with slug,
    bilingual name/description, category, icon, nodeCount, definition (jsonb)
  - Seeded 12 workflow templates across 5 categories:
      Universal (5): Customer Inquiry, Lead Qualification, Daily Summary,
        Content Review, Task Escalation
      Marketing (2): Campaign Launch, Social Media Monitor
      E-commerce (2): Order Follow-up, Inventory Alert
      SaaS (2): User Onboarding Drip, Churn Prevention
      Finance (1): Invoice Processing
  - Each template has full React Flow node/edge definitions with positioned
    nodes (trigger, agent, condition, approval, output, delay types)
  - New tRPC router: workflowTemplates.list (with category filter),
    workflowTemplates.getById, workflowTemplates.use (copies to project)
  - New gallery page at /workflows/templates with DOS-style category filter
    tabs, responsive card grid, node-type color dots, Use Template button
  - Added "Browse Templates" button to workflows page header + empty state
  - Full i18n: 40+ keys in both en-US and pt-BR

FILES: 10 changed (4 new), +829 -15
  - NEW: packages/db/src/schema/workflow-templates.ts
  - NEW: packages/db/src/seed/workflow-templates.ts
  - NEW: packages/api/src/routers/workflow-templates.ts
  - NEW: apps/web/src/app/[locale]/(auth)/workflows/templates/page.tsx
  - MODIFIED: packages/db/src/schema/index.ts
  - MODIFIED: packages/db/src/seed.ts
  - MODIFIED: packages/api/src/root.ts
  - MODIFIED: apps/web/messages/en-US.json
  - MODIFIED: apps/web/messages/pt-BR.json
  - MODIFIED: apps/web/src/app/[locale]/(auth)/workflows/page.tsx

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #55 — Remove Project Rail (Duplicate of Header Selector)
================================================================================
DATE: 2026-02-27
HASH: fa70193
PHASE: Post-Phase 3 — Polish

WHAT CHANGED:
  - Removed ProjectRail and RailExpandButton components from AppShell
  - Deleted project-rail.tsx (90 lines) — the far-left vertical project
    switcher was redundant since the header already has a project selector
  - Cleaned up ui-store.ts: removed railCollapsed, toggleRail, setRailCollapsed
    state (no longer needed)

FILES: 3 changed (1 deleted), 102 deletions
  - DELETED: apps/web/src/components/layout/project-rail.tsx
  - MODIFIED: apps/web/src/components/layout/app-shell.tsx
  - MODIFIED: apps/web/src/stores/ui-store.ts

VERIFICATION:
  - tsc --noEmit: 0 errors

================================================================================


================================================================================
COMMIT #52 — Docs: Add 6 Undocumented Feature Sections
================================================================================
DATE: 2026-02-26
HASH: c347540
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS BUILT:
  - Added 6 new documentation sections for features that were built but not
    documented in the public docs page (13 topics → 19 topics)
  - New sections: ATLAS, Activity Log, Virtual Office, Settings, Help Center,
    Onboarding — each with subtopics in sidebar navigation
  - ATLAS: Orb visualization states (4 colors), voice+text conversation,
    state machine flow, mock limitations noted
  - Activity Log: Log list with filters, action detail drawer, session timeline,
    marked as real data (not mock)
  - Virtual Office: 3D isometric view, 5 agent status colors with visual
    indicators, 9 rooms layout, agent inspector panel, team roster
  - Settings: General/Members/Billing/Notifications tabs, Stripe stub noted
  - Help Center: Alpha Playbook with 8 accordion sections, quick start guide
  - Onboarding: 6-step wizard (welcome → company → template → integration →
    agent → done), template system, Framer Motion transitions
  - Added 6 new Lucide icon imports (Radio, Activity, Building2, Settings,
    HelpCircle, Compass)

FILES: 1 changed, 498 insertions(+)
  - MODIFIED: apps/web/src/app/[locale]/(public)/docs/_lib/docs-data.tsx
    (786 → 1284 lines)

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #51 — Docs Sidebar + Multi-Page Layout
================================================================================
DATE: 2026-02-26
HASH: 3f51a60
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS BUILT:
  - Redesigned docs from single 770-line page into a sidebar + multi-page layout
  - _lib/docs-data.tsx: TOC structure (13 topics with subtopics), content map
    (Record<slug, JSX>), shared helpers (StatusBadge, FeatureList, etc.)
  - _components/docs-sidebar.tsx: client component with expand/collapse, active
    topic highlighting (cyan), subtopic anchor links, mobile drawer toggle
  - layout.tsx: persistent header + 2-column flex (sidebar + scrollable content)
    + footer CTA and footer
  - [topic]/page.tsx: dynamic route with generateStaticParams for all 13 topics,
    redirects to /docs/overview if topic not found
  - docs/page.tsx: now just redirects to /docs/overview
  - middleware.ts: updated public routes from /docs to /docs(.*)

FILES: 6 changed, 1003 insertions(+), 768 deletions(-)
  - NEW: apps/web/src/app/[locale]/(public)/docs/_lib/docs-data.tsx
  - NEW: apps/web/src/app/[locale]/(public)/docs/_components/docs-sidebar.tsx
  - NEW: apps/web/src/app/[locale]/(public)/docs/layout.tsx
  - NEW: apps/web/src/app/[locale]/(public)/docs/[topic]/page.tsx
  - MODIFIED: apps/web/src/app/[locale]/(public)/docs/page.tsx
  - MODIFIED: apps/web/src/middleware.ts

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #50 — Landing Page
================================================================================
DATE: 2026-02-26
HASH: a326044
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS BUILT:
  - Replaced redirect-to-office with a proper public landing page at /{locale}
  - Hero section with app name, tagline, "Get Started" and "Sign In" CTAs
  - Feature highlights grid: AI Agents, Live Simulation, Workflows, WhatsApp
  - Dark DOS aesthetic using existing design tokens, zero border-radius
  - Locale-aware links via @/i18n/navigation Link component

FILES: 1 changed, 104 insertions(+), 9 deletions(-)
  - MODIFIED: apps/web/src/app/[locale]/page.tsx

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #1 — Epic P0-1: Monorepo & Project Scaffolding
================================================================================
Hash:     9f3beec55be0c08b2c4c675cfa63a34c42a30f0b
Date:     2026-02-24 17:46:38 -0300
Tasks:    P0-1.1 through P0-1.7 (7 tasks)
================================================================================

WHAT WAS BUILT:
  - Root monorepo with Turborepo + pnpm workspaces
  - turbo.json with pipelines: build, dev, lint, typecheck, test, clean
  - apps/web: Next.js 15, App Router, Tailwind CSS v4, Turbopack
    - Directory structure for all 11 screens under [locale]/(auth)/
    - globals.css with 24 design system CSS tokens
    - IBM Plex Mono font via next/font/google
    - PostCSS config for Tailwind v4
  - apps/worker: Node.js TypeScript service
    - HTTP health endpoint on port 4000
    - Graceful SIGTERM shutdown
    - tsx for dev hot-reload
  - packages/db: Drizzle ORM (schema, migrations, client, seed scripts)
  - packages/api: tRPC with superjson transformer, publicProcedure, root router
  - packages/shared: TypeScript types, Zod schemas, constants, utilities
  - packages/ai: Agent engine package (stub, populated in P0-6/P0-7)
  - packages/queue: BullMQ queue definitions (stub, populated in P0-3)
  - packages/realtime: Socket.IO event types (stub, populated in P0-9)
  - packages/tsconfig: Shared configs (base, nextjs, node, library)
  - packages/eslint-config: Shared ESLint configs (base, next, node)
  - docker-compose.yml: PostgreSQL 16 (pgvector image) + Redis 7-alpine
  - .env.example with all 11 required environment variables
  - Prettier config (.prettierrc + .prettierignore)
  - .gitignore, .npmrc

FILES CREATED (64 files):
  Root:
    .env.example, .gitignore, .npmrc, .prettierignore, .prettierrc,
    docker-compose.yml, package.json, pnpm-lock.yaml, pnpm-workspace.yaml,
    turbo.json
  apps/web:
    .eslintrc.cjs, next.config.mjs, package.json, postcss.config.mjs,
    tsconfig.json, src/app/globals.css, src/app/layout.tsx, src/app/page.tsx
  apps/worker:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/db:
    .eslintrc.cjs, drizzle.config.ts, package.json, tsconfig.json,
    src/client.ts, src/index.ts, src/schema/index.ts
  packages/api:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts, src/root.ts,
    src/trpc.ts
  packages/shared:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts,
    src/types/index.ts, src/constants/index.ts, src/schemas/index.ts,
    src/utils/index.ts
  packages/ai:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/queue:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/realtime:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/tsconfig:
    package.json, base.json, library.json, nextjs.json, node.json
  packages/eslint-config:
    package.json, base.js, next.js, node.js

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. .eslintrc.js used CJS syntax (module.exports) in ESM packages ("type":"module")
       → Renamed all 7 files to .eslintrc.cjs
    2. Font-family in globals.css used literal 'IBM Plex Mono' instead of CSS var
       → Changed to var(--font-family-mono) referencing var(--font-mono) from next/font
    3. Missing --font-family-mono in @theme block, so Tailwind font-mono utility broken
       → Added --font-family-mono to @theme

  MEDIUM (6):
    4. next.config.js and postcss.config.js used ESM export without "type":"module"
       → Renamed both to .mjs
    5. --spacing-* tokens in wrong Tailwind v4 namespace
       → Moved to --width-* and --height-* namespaces
    6. Duplicate bullmq + ioredis in both worker and queue packages
       → Removed from worker, consumed through @ai-office/queue only
    7. 26 CSS tokens instead of spec's 24 (duplicate risk/status colors)
       → Removed 3 duplicate risk tokens, kept only --color-risk-critical
    8. Hardcoded lang="pt-BR" in layout (will be dynamic with i18n)
       → Noted for P0-8 fix
    9. Non-null assertion (!) on DATABASE_URL in drizzle.config.ts
       → Added runtime check with clear error message

  MINOR (3):
    10. Missing explicit outputs:[] in turbo lint/typecheck/test tasks → Added
    11. Missing eslint-config-next peer dependency → Added as optional
    12. Aggressive * { border-radius: 0 !important } → Replaced with --radius-* tokens

VERIFICATION:
  - pnpm install: zero errors across 11 workspaces
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Design system: 24 CSS tokens confirmed


================================================================================
COMMIT #2 — Epic P0-2: PostgreSQL & Drizzle ORM Setup
================================================================================
Hash:     12b302d05673b6c166451fc94e6c819216b31b8a
Date:     2026-02-24 17:56:18 -0300
Tasks:    P0-2.1 through P0-2.9 (9 tasks; P0-2.10 Supabase RLS deferred to staging)
================================================================================

WHAT WAS BUILT:
  15 database tables across 10 schema files:
    - organizations: uuid PK, name, slug (unique), clerk_org_id, plan enum
    - users: uuid PK, clerk_user_id (unique), email, name, locale, role enum, org FK
    - projects: uuid PK, org FK, name, slug, color, composite unique (org_id, slug)
    - agents: uuid PK, project FK, name, archetype/status/trigger enums, config jsonb,
              tools text[], system prompts (EN+PT-BR), unique (project_id, slug)
    - agent_memory: uuid PK, agent FK, project FK, key/value, embedding vector(1536)
    - action_logs: uuid PK, project FK, agent FK, session_id, action_type, tokens,
                   cost, duration, composite index (project_id, created_at)
    - approvals: uuid PK, project FK, agent FK, action_log FK, risk_level enum,
                 status enum, reviewed_by FK (nullable)
    - workflows: uuid PK, project FK, name, definition jsonb (React Flow graph)
    - workflow_runs: uuid PK, workflow FK, project FK, status enum
    - workflow_node_runs: uuid PK, run FK, project FK, node_id, agent FK
    - documents: uuid PK, project FK, title, source_type enum, content
    - document_chunks: uuid PK, document FK, project FK, embedding vector(1536)
    - strategies: uuid PK, project FK, type enum, user_draft, ai_refined, status enum
    - strategy_kpis: uuid PK, strategy FK, project FK, current/target values
    - strategy_learnings: uuid PK, strategy FK, project FK, agent FK, insight

  Supporting files:
    - custom-types.ts: pgvector vector(1536) custom Drizzle type
    - enums.ts: 16 PostgreSQL enums (plan, user_role, locale, agent_archetype,
                agent_status, trigger_type, memory_scope, action_status, risk_level,
                approval_status, workflow_run_status, document_source_type,
                strategy_type, strategy_status, kpi_direction)
    - seed.ts: Idempotent seed script creating 1 org, 1 user, 1 project,
               3 agents (Support/Sales/Data Analyst with PT-BR prompts),
               5 action log entries

FILES CREATED (12 new, 1 modified):
  packages/db/src/schema/:
    custom-types.ts, enums.ts, organizations.ts, users.ts, projects.ts,
    agents.ts, action-logs.ts, approvals.ts, workflows.ts, documents.ts,
    strategies.ts
  packages/db/src/:
    seed.ts
  Modified:
    packages/db/src/schema/index.ts (barrel export updated)

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (4):
    1. projects.slug had no unique constraint → seed onConflictDoNothing silently failed
       → Added composite unique index (org_id, slug)
    2. Seed project used onConflictDoNothing (returns empty on conflict)
       → Changed to onConflictDoUpdate so .returning() always returns the row
    3. Agents inserted with plain insert (no upsert, duplicates on re-run)
       → Added unique (project_id, slug) + seed now uses onConflictDoUpdate
    4. Action logs inserted with plain insert (duplicates on re-run)
       → Added guard: check existing logs for project before inserting

  MEDIUM (3):
    5. workflow_node_runs missing project_id FK (every child table needs it for RLS)
       → Added project_id FK with cascade delete
    6. strategy_kpis missing createdAt timestamp (every other table has it)
       → Added createdAt with defaultNow()
    7. Redundant org_slug_idx index (slug already has .unique() which creates index)
       → Removed the redundant explicit index

  MINOR (1):
    8. users table missing updatedAt (mutable fields: role, locale, timezone)
       → Added updatedAt with $onUpdate

  ALSO FIXED DURING CODING (before review):
    - Missing jsonb import in approvals.ts
    - vector custom type fromDriver param typed as string instead of unknown
    - Duplicate vector type definition in agents.ts and documents.ts
      → Extracted to shared custom-types.ts

VERIFICATION:
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Table count: 15 confirmed
  - Seed idempotency: org+user use onConflictDoUpdate, project uses onConflictDoUpdate
    with composite target, agents use onConflictDoUpdate, logs guarded with SELECT


================================================================================
COMMIT #3 — Epic P0-3: Redis & BullMQ Queue System
================================================================================
Hash:     f528052
Date:     2026-02-24 ~18:20 -0300
Tasks:    P0-3.1 through P0-3.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  packages/queue/src/:
    - connection.ts: BullMQ connection options factory (parses REDIS_URL,
      includes db index, enableReadyCheck, maxRetriesPerRequest)
    - jobs.ts: 7 Zod schemas for typed job payloads (AgentExecution,
      AgentScheduled, ToolExecution, EmbeddingGeneration, Notification,
      Analytics, Cleanup)
    - queues.ts: 7 BullMQ queue instances as lazy singletons with
      per-queue retry/backoff config + removeOnFail:false (dead letter)
    - index.ts: Barrel export (QUEUE_NAMES, getters, schemas, types)

  apps/worker/src/:
    - workers/create-worker.ts: Generic typed worker factory with
      Zod validation, error/completed/failed/stalled handlers
    - workers/*.worker.ts: 7 stub workers using factory pattern
    - index.ts: Express server + Bull Board (dev) + health endpoint
      + graceful shutdown with 30s timeout + global error handlers

  Queue architecture (7 queues):
    agent-execution:   concurrency=5,  retry=3x 30s exp backoff
    agent-scheduled:   concurrency=3,  retry=3x 30s exp backoff
    tool-execution:    concurrency=10, retry=5x 10s exp backoff
    embedding-generation: concurrency=3, retry=3x 15s exp backoff
    notification:      concurrency=5,  retry=5x 60s exp backoff
    analytics:         concurrency=1,  retry=3x 60s exp backoff
    cleanup:           concurrency=1,  retry=2x 120s exp backoff

FILES CREATED (11 new, 4 modified):
  New:
    packages/queue/src/connection.ts, jobs.ts, queues.ts
    apps/worker/src/workers/create-worker.ts
    apps/worker/src/workers/{agent-execution,agent-scheduled,tool-execution,
      embedding-generation,notification,analytics,cleanup}.worker.ts
    apps/worker/src/workers/index.ts
  Modified:
    packages/queue/src/index.ts, packages/queue/package.json
    apps/worker/src/index.ts, apps/worker/package.json, pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. Workers never validated job payloads with Zod at runtime
       → Created createTypedWorker factory with schema.parse() on every job
    2. getConnectionOptions() missing enableReadyCheck:false (race on reconnect)
       → Added to connection options
    3. createRedisConnection() was a footgun (unused but exported, leaked connections)
       → Removed entirely, only getConnectionOptions() remains

  HIGH (2):
    4. Graceful shutdown could hang indefinitely (no timeout)
       → Added 30s hard-exit timeout + server.closeAllConnections()
    5. getConnectionOptions() dropped Redis db index from URL path
       → Added db: Number(parsed.pathname.slice(1)) parsing

  MEDIUM (1):
    6. No error event handlers on workers (could crash process)
       → Added worker.on('error') in the factory

  LOW (3) — also fixed:
    7. No unhandledRejection/uncaughtException handlers → Added
    8. 7 worker files were 250+ lines of boilerplate → Extracted factory (30 lines)
    9. Unused socket.io dep in worker → Removed (will add in P0-9)
    10. Unused @ai-office/shared dep in queue package → Removed

  ALSO FIXED DURING CODING (before review):
    - Missing zod dep in packages/queue/package.json
    - ioredis import: default vs named export issue with NodeNext resolution
      → Used named import { Redis } from 'ioredis'
    - bull-board adapter import path: .js extension not in exports map
      → Removed .js suffix
    - bullmq needed as direct dep in worker (Worker class import)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - pnpm install: zero errors across all workspaces
  - All 7 queues match roadmap concurrency and retry specs
  - All 7 workers validate payloads with Zod before processing


================================================================================
COMMIT #5 — Epic P0-4: CI/CD Pipeline — GitHub Actions, Vercel, Railway
================================================================================
Hash:     bec2cb2
Date:     2026-02-24 ~19:30 -0300
Tasks:    P0-4.1 through P0-4.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  .github/workflows/ci.yml:
    - Triggers: pull_request + push to main/develop + workflow_call (reusable)
    - Node.js matrix: 20, 22
    - Services: pgvector/pgvector:pg16 + redis:7-alpine with health checks
    - Steps: checkout → pnpm 9 → Node.js → install → lint → typecheck → test → build
    - Concurrency: cancel-in-progress per ref
    - timeout-minutes: 15

  .github/workflows/deploy-staging.yml:
    - Trigger: push to develop
    - Job graph: ci (gate) → migrate-db → deploy-web + deploy-worker (parallel)
    - cancel-in-progress: false (prevents partial deploys)
    - Web: Vercel (preview environment)
    - Worker: Railway CLI (staging environment)

  .github/workflows/deploy-production.yml:
    - Trigger: push to main
    - Job graph: ci (gate) → migrate-db → deploy-web + deploy-worker (parallel)
    - cancel-in-progress: false
    - Web: Vercel (production environment, --prod flag)
    - Worker: Railway CLI (production environment)

  vercel.json:
    - Framework: nextjs
    - installCommand: pnpm install --frozen-lockfile
    - buildCommand: pnpm turbo build --filter=web
    - No rootDirectory (runs from repo root for monorepo compat)

  apps/worker/Dockerfile:
    - Multi-stage build (builder + runner)
    - Base: node:20-alpine
    - Copies ALL workspace package.json files (pnpm lockfile requirement)
    - Build: pnpm turbo build --filter=worker...
    - Prune: pnpm prune --prod (in builder, before copy to runner)
    - Non-root user: worker (uid 1001)
    - HEALTHCHECK: wget http://localhost:4000/health every 30s
    - Exposes port 4000

  .dockerignore:
    - Excludes: node_modules, .git, .github, .turbo, .next, .env*, *.md,
      dist, coverage, .vscode, .idea
    - Allows: .env.example

FILES CREATED (6 new):
  .github/workflows/ci.yml
  .github/workflows/deploy-staging.yml
  .github/workflows/deploy-production.yml
  vercel.json
  apps/worker/Dockerfile
  .dockerignore

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. ci.yml missing workflow_call trigger → production deploy referenced it as
       reusable workflow but it had no workflow_call trigger → Added
    2. Dockerfile missing packages/api and apps/web package.json → pnpm
       --frozen-lockfile fails when workspace packages are absent → Added ALL
       workspace package.json files
    3. deploy-web ran in parallel with migrate-db (web could deploy before
       migrations) → Changed deploy-web needs to [ci, migrate-db]

  HIGH (5):
    4. Staging deploy had no CI gate → Added ci job using workflow_call
    5. Staging deploy was missing database migrations → Added migrate-db job
    6. Dockerfile ran as root → Added non-root user (worker, uid 1001)
    7. Dockerfile copied full node_modules with devDeps to runner → Added
       pnpm prune --prod in builder stage before copy
    8. vercel.json buildCommand used fragile "cd ../.. &&" path → Changed to
       root-relative "pnpm turbo build --filter=web", removed rootDirectory

  MEDIUM (2):
    9. Staging cancel-in-progress:true could leave partial deploys → Changed
       to false (matches production)
    10. No timeout on CI job (default 6h) → Added timeout-minutes: 15

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - All 3 workflows have correct job dependency graphs
  - Dockerfile includes all 10 workspace package.json files
  - Non-root user configured in runner stage


================================================================================
COMMIT #7 — Epic P0-5: Authentication & Multi-Tenancy (Clerk)
================================================================================
Hash:     c424e05
Date:     2026-02-24 ~20:15 -0300
Tasks:    P0-5.1 through P0-5.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  apps/web/src/middleware.ts:
    - Clerk middleware with clerkMiddleware() + createRouteMatcher
    - Public routes: /, /sign-in, /sign-up, /:locale/sign-in, /:locale/sign-up,
      /api/webhooks
    - All other routes require authentication

  apps/web/src/app/layout.tsx:
    - Wrapped with ClerkProvider
    - IBM Plex Mono font, dark theme globals.css

  apps/web/src/app/(public)/sign-in/[[...sign-in]]/page.tsx:
    - Clerk SignIn component with dark theme appearance overrides

  apps/web/src/app/(public)/sign-up/[[...sign-up]]/page.tsx:
    - Clerk SignUp component with dark theme appearance overrides

  apps/web/src/app/api/webhooks/clerk/route.ts:
    - Svix webhook signature verification (uses raw body text)
    - user.created: creates personal org (slug: personal-{clerkId}),
      default project, user (idempotent with onConflictDoUpdate)
    - user.updated: syncs email, name, avatar
    - user.deleted: removes user + cleans up orphaned org if no members
    - organization.created: upserts org by clerkOrgId, creates default project
    - organizationMembership.created: updates user orgId + maps Clerk role
      (org:admin→admin, org:member→viewer)

  apps/web/src/stores/project-store.ts:
    - Zustand store with persist middleware (skipHydration for SSR)
    - State: currentOrgId, currentProjectId, userRole, organizations, projects
    - Selectors: useActiveProject(), useProjects(), useUserRole(), useActiveOrg()
    - Only currentOrgId + currentProjectId persisted to localStorage

  packages/api/src/trpc.ts:
    - createTRPCContext: accepts clerkUserId + projectId, looks up user/org/project
    - publicProcedure: no auth required
    - protectedProcedure: requires auth + org (narrows both to non-null)
    - projectProcedure: requires auth + org + project, sets RLS session var
      via parameterized SQL: set_config('app.current_project_id', $1, true)
    - requireRole(minimumRole): middleware factory with hierarchy
      viewer(0) < manager(1) < admin(2) < owner(3)
    - adminProcedure: projectProcedure + requireRole('admin')
    - ownerProcedure: projectProcedure + requireRole('owner')

FILES CREATED (5 new, 7 modified):
  New:
    apps/web/src/middleware.ts
    apps/web/src/app/(public)/sign-in/[[...sign-in]]/page.tsx
    apps/web/src/app/(public)/sign-up/[[...sign-up]]/page.tsx
    apps/web/src/app/api/webhooks/clerk/route.ts
    apps/web/src/stores/project-store.ts
  Modified:
    apps/web/src/app/layout.tsx (added ClerkProvider)
    apps/web/package.json (added @clerk/nextjs, svix, drizzle-orm)
    packages/api/src/trpc.ts (full rewrite with auth context)
    packages/api/src/index.ts (new exports)
    packages/api/package.json (added drizzle-orm, @types/node)
    .env.example (added CLERK_WEBHOOK_SECRET, after sign-in/up URLs)
    pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (1):
    1. SQL injection in RLS set_config via string interpolation
       → Changed to parameterized query using drizzle-orm sql tag

  HIGH (4):
    2. Webhook body re-serialization (JSON.parse→JSON.stringify) could break
       svix signature verification → Changed to req.text() for raw body
    3. user.created handler not idempotent — plain INSERT without conflict
       handling caused failures on webhook replay → Added onConflictDoUpdate
    4. organization.created used clerkOrgId as conflict target but slug
       collision would throw unhandled error → Wrapped in try/catch
    5. organizationMembership.created did not map Clerk role, kept old role
       (privilege escalation risk) → Added role mapping (org:admin→admin,
       org:member→viewer)

  MEDIUM (5):
    6. Webhook threw raw Error on missing CLERK_WEBHOOK_SECRET → Changed to
       console.error + HTTP 500 response
    7. Org slug from email prefix could collide across domains → Changed to
       personal-{clerkId} format
    8. Zustand persist caused SSR hydration mismatch → Added skipHydration:true
    9. Middleware public routes didn't account for locale-prefixed paths
       → Added /:locale/sign-in and /:locale/sign-up patterns
    10. enforceAuth middleware did not narrow org to non-null → Added org
        null check with INTERNAL_SERVER_ERROR

  ALSO FIXED DURING CODING:
    - Missing @types/node in packages/api (needed for process.env in db client)
    - Missing drizzle-orm in web app (needed for eq() in webhook handler)
    - undici-types inference error on POST handler → Added explicit
      Promise<Response> return type
    - Role mapping type mismatch (string vs enum) → Used typed roleMap
      with UserRole type alias

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Webhook handler fully idempotent for all 5 event types
  - RLS set_config uses parameterized SQL (no injection risk)
  - Role hierarchy: viewer(0) < manager(1) < admin(2) < owner(3)


================================================================================
COMMIT #9 — Epic P0-6: LLM Observability (Helicone + Sentry)
================================================================================
Hash:     2e78b43
Date:     2026-02-24 ~21:00 -0300
Tasks:    P0-6.1 through P0-6.4 (4 tasks)
================================================================================

WHAT WAS BUILT:
  packages/ai/src/client.ts:
    - createAnthropicClient(): routes through Helicone proxy with custom
      properties (ProjectId, AgentId, SessionId, AgentName)
    - createDirectClient(): cached singleton for direct Anthropic API
    - getApiKey(): validates ANTHROPIC_API_KEY with clear error message
    - Auto-falls back to direct API when HELICONE_API_KEY is unset

  packages/ai/src/engine/llm.ts:
    - callLLM() wrapper around messages.create() with:
      - Helicone proxy with 5s timeout (HELICONE_TIMEOUT_MS)
      - Fallback to direct API on APIConnectionError or 5xx (typed detection)
      - Token tracking: input_tokens, output_tokens, total
      - Cost calculation from MODEL_PRICING table (warns on unknown models)
      - Latency measurement via performance.now()
      - action_logs persistence (non-blocking: DB failure doesn't discard response)
    - Model pricing: claude-sonnet-4-6 ($3/$15), claude-haiku-4-5 ($0.8/$4),
      claude-opus-4-6 ($15/$75)

  apps/web/ Sentry integration:
    - sentry.client.config.ts: NEXT_PUBLIC_SENTRY_DSN, 10% prod traces
    - sentry.server.config.ts: same DSN, 10% prod traces
    - sentry.edge.config.ts: same DSN, 10% prod traces
    - next.config.mjs: withSentryConfig wrapper, source map upload config

  apps/worker/ Sentry integration:
    - Sentry.init() at top of index.ts (no-op if DSN unset)
    - captureException on unhandledRejection + uncaughtException

  packages/db/src/index.ts:
    - Re-exports drizzle-orm operators (eq, and, or, sql, desc, asc, etc.)
      to prevent pnpm duplicate package instances across workspaces

FILES CREATED (4 new, 11 modified):
  New:
    packages/ai/src/client.ts
    packages/ai/src/engine/llm.ts
    apps/web/sentry.client.config.ts
    apps/web/sentry.server.config.ts
    apps/web/sentry.edge.config.ts
  Modified:
    packages/ai/src/index.ts (barrel exports)
    packages/ai/package.json (added drizzle-orm, @types/node)
    packages/db/src/index.ts (drizzle-orm re-exports)
    apps/web/next.config.mjs (withSentryConfig wrapper)
    apps/web/package.json (added @sentry/nextjs, removed direct drizzle-orm)
    apps/web/src/app/api/webhooks/clerk/route.ts (import from @ai-office/db)
    apps/worker/package.json (added @sentry/node)
    apps/worker/src/index.ts (Sentry init + captureException)
    .env.example (added SENTRY_AUTH_TOKEN, SENTRY_ORG, SENTRY_PROJECT)
    pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (4):
    1. Fallback detection used includes('5') — matched any string with digit 5
       → Changed to APIConnectionError/APIError(status>=500) typed detection
    2. Missing ANTHROPIC_API_KEY silently passed undefined to SDK
       → Added getApiKey() with clear error message
    3. DB insert failure in error path swallowed original LLM error
       → Wrapped error-path DB insert in try/catch
    4. DB insert failure in success path discarded valid LLM response
       → Wrapped success-path insert in try/catch, returns result regardless

  HIGH (5):
    5. New Anthropic client created per call (connection pool churn)
       → Cached direct client as singleton via createDirectClient()
    6. costUsd.toFixed(6) introduced floating-point rounding before Postgres
       → Changed to String(costUsd), let Postgres handle numeric(10,6)
    7. Non-null assertion on actionLog!.id unsafe → Used actionLog?.id ?? null
    8. Inconsistent Sentry DSN env vars (SENTRY_DSN vs NEXT_PUBLIC_SENTRY_DSN)
       → Unified on NEXT_PUBLIC_SENTRY_DSN everywhere
    9. Sentry.captureException called without init when DSN unset
       → Always call Sentry.init() (no-op without DSN)

  MEDIUM (4):
    10. LLMCallError type exported but never used (dead code) → Removed
    11. HELICONE_TIMEOUT_MS defined but never applied → Now passed to SDK
    12. Hardcoded pricing with silent fallback → Added console.warn for unknown models
    13. replaysOnErrorSampleRate without replayIntegration → Removed replay config

  ALSO FIXED DURING CODING:
    - pnpm drizzle-orm duplicate instance (web vs db) → Re-exported from @ai-office/db
    - Duplicate import lines in llm.ts → Combined to single import
    - Removed unused SENTRY_DSN from .env.example, added SENTRY_AUTH_TOKEN/ORG/PROJECT

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Fallback uses typed SDK error classes (no string matching)
  - DB logging is non-blocking in both error and success paths
  - Direct client cached as singleton


================================================================================
COMMIT #11 — Epic P0-7: First Agent Execution Loop
================================================================================
Hash:     fb7a4f4
Date:     2026-02-24 ~22:00 -0300
Tasks:    P0-7.1 through P0-7.6 (6 tasks)
================================================================================

WHAT WAS BUILT:
  packages/ai/src/engine/types.ts:
    - AgentSession: sessionId, agentId, projectId, startedAt, actionCount,
      totalTokens, totalCostUsd, status, abortReason
    - AgentContext: agent config, systemPrompt, tools: ToolDefinition[],
      memory, conversationHistory, triggerPayload
    - ToolDefinition: name, description, inputSchema (Zod), requiresApproval,
      execute(input, context)
    - ToolExecutionContext: agentId, projectId, sessionId
    - ExecutionResult: sessionId, status, actions, finalResponse, totalTokens,
      totalCostUsd, durationMs, abortReason
    - ActionRecord: type (llm_call | tool_call), toolName, input, output,
      error, tokensUsed, costUsd, durationMs
    - SafetyLimits: maxActionsPerSession(20), maxTokensPerSession(100K),
      maxDurationMs(5min), maxConsecutiveErrors(3), toolCallMinIntervalMs(2s)

  packages/ai/src/engine/executor.ts — Core agentic loop:
    - Builds messages from context (merges to avoid consecutive user messages)
    - Calls Claude via callLLM with tool definitions from registry
    - Detects stop_reason: max_tokens → abort with "[Response truncated]"
    - Tool execution: Zod validation → approval check → rate limit (2s) →
      execute with 60s timeout (timer cleared with .finally())
    - Truncates tool results to 10K chars to prevent context window bloat
    - Failed LLM calls count toward action limit
    - Non-blocking action_logs persistence
    - Safety checks per iteration: action count, token budget, duration,
      consecutive errors
    - Ensures terminal status (completed | error | aborted) before returning

  packages/ai/src/tools/registry.ts:
    - ToolRegistry class: register, get, getAll, getByNames, toAnthropicTools
    - zodToJsonSchema + zodTypeToJsonSchema: hand-rolled converters for
      ZodString, ZodNumber, ZodBoolean, ZodOptional, ZodArray, ZodEnum, ZodObject
    - 3 stub tools:
      - get_current_time: returns ISO timestamp + timezone
      - search_company_memory: placeholder for vector search
      - log_message: structured JSON logging (prevents log injection)

  packages/ai/src/memory/individual.ts:
    - loadMemory(agentId, projectId): loads all key/value entries
    - saveMemory(agentId, projectId, key, value): race-safe upsert
      (try INSERT, catch duplicate → UPDATE fallback)
    - searchMemory(agentId, projectId, query, topK): stub returning all
      entries (TODO P1: vector similarity with pgvector)

  apps/worker/src/jobs/agent-execution.ts:
    - processAgentExecution(data): full agent execution handler
    - CAS concurrency guard: UPDATE agents SET status='working'
      WHERE id=agentId AND status='idle' (prevents parallel runs)
    - Loads agent config, memory, builds context, creates session
    - Configurable limits: maxActionsPerSession from agent config,
      token budget from cost budget × 100K
    - Sentry.captureException on failure with agentId/projectId/sessionId tags
    - Updates agent status to idle (success) or error (failure)

  packages/ai/src/index.ts:
    - Updated barrel exports for all engine components:
      executeAgent, AgentSession, AgentContext, ToolDefinition,
      ToolExecutionContext, ExecutionResult, ActionRecord, SafetyLimits,
      DEFAULT_SAFETY_LIMITS, toolRegistry, loadMemory, saveMemory, searchMemory

FILES CREATED (5 new, 2 modified):
  New:
    packages/ai/src/engine/types.ts
    packages/ai/src/engine/executor.ts
    packages/ai/src/tools/registry.ts
    packages/ai/src/memory/individual.ts
    apps/worker/src/jobs/agent-execution.ts
  Modified:
    packages/ai/src/index.ts (barrel exports)
    pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. Failed LLM calls did not increment actionCount → could infinite-loop
       on persistent API errors → Added session.actionCount++ in catch block
    2. Promise.race timer leaked on successful tool execution → clearTimeout
       never called → Added .finally(() => clearTimeout(timeoutId!))
    3. Unbounded tool result strings could fill context window → Added
       MAX_TOOL_RESULT_LENGTH (10K chars) truncation with "[truncated]" marker

  HIGH (5):
    4. Consecutive user messages would violate Anthropic API contract
       → Added merge logic: if last message is user role, concatenate content
    5. stop_reason: max_tokens treated as successful completion (silent
       truncation) → Detect stop_reason and abort with clear message
    6. No concurrency guard → agent could run multiple sessions in parallel
       → CAS: UPDATE WHERE status='idle', skip if already working
    7. requiresApproval tools created wasteful retry loop (never-ending
       tool call attempts) → Abort session with reason message for review
    8. Log injection via log_message tool → Structured JSON logging with
       JSON.stringify and message length limit (1000 chars)

  MEDIUM (9):
    9. safeStringify helper missing (JSON.stringify could throw on circular refs)
       → Added try/catch wrapper with String() fallback
    10. toolDef.execute called with raw input before Zod validation
        → Moved validation before execution, use parseResult.data
    11. Wrong duration calculated for error actions (used shared start time)
        → Per-call llmCallStart/toolStart timestamps
    12. Missing type narrowing on tool_use blocks → Added type predicate filter
    13. No rate limiting between tool calls → Added toolCallMinIntervalMs (2s)
    14. Worker imported from deep @ai-office/ai paths → Updated barrel exports
    15. zodToJsonSchema fragile (doesn't handle ZodDefault, ZodNullable, etc.)
        → Acknowledged: TODO replace with zod-to-json-schema library
    16. Anthropic Tool type mismatch in inline tool generation
        → Simplified to use registry.toAnthropicTools()
    17. triggerPayload could be huge → Sliced to 10K chars

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - All safety limits enforced: actions, tokens, duration, errors, rate limit
  - Timer cleanup verified (no leaks in Promise.race)
  - CAS concurrency guard prevents parallel agent sessions
  - Tool results truncated to 10K chars
  - All 3 stub tools registered and functional


================================================================================
COMMIT #13 — Epic P0-8: Internationalization (next-intl)
================================================================================
Hash:     d9ee26e
Date:     2026-02-24 ~23:00 -0300
Tasks:    P0-8.1 through P0-8.4 (4 tasks)
================================================================================

WHAT WAS BUILT:
  apps/web/src/i18n/routing.ts:
    - defineRouting() with locales: ['pt-BR', 'en-US'], default: 'pt-BR'
    - Exported Locale type

  apps/web/src/i18n/request.ts:
    - getRequestConfig() for server components
    - Dynamic message import with try/catch fallback to default locale
    - Validates locale against routing.locales via hasLocale()

  apps/web/src/i18n/navigation.ts:
    - createNavigation(routing) → Link, redirect, usePathname, useRouter,
      getPathname (locale-aware navigation utilities)

  apps/web/src/middleware.ts:
    - Combined Clerk + next-intl middleware
    - intlMiddleware runs inside clerkMiddleware callback, returning the
      intl response for Clerk to decorate with auth headers
    - Public routes include bare and locale-prefixed sign-in/sign-up/root
    - API/webhook routes excluded from locale handling

  apps/web/src/app/layout.tsx:
    - Stripped to pass-through: renders only {children}
    - Imports globals.css (no <html>/<body> — those live in [locale] layout)

  apps/web/src/app/[locale]/layout.tsx:
    - Renders <html lang={locale}> with IBM Plex Mono font variable
    - ClerkProvider with locale-aware signInUrl, signUpUrl, afterSignOutUrl
    - NextIntlClientProvider with locale + messages
    - Validates locale via hasLocale(), calls notFound() on invalid
    - generateStaticParams() for SSG support
    - Metadata: title + description

  apps/web/src/app/[locale]/page.tsx:
    - Uses useTranslations('common') for localized content

  apps/web/src/app/[locale]/(public)/sign-in/[[...sign-in]]/page.tsx:
    - Clerk SignIn with forceRedirectUrl={`/${locale}`}
    - Dark theme appearance overrides

  apps/web/src/app/[locale]/(public)/sign-up/[[...sign-up]]/page.tsx:
    - Clerk SignUp with forceRedirectUrl={`/${locale}`}
    - Dark theme appearance overrides

  apps/web/src/app/not-found.tsx:
    - Root 404 page (outside locale segment, inline styles)

  apps/web/src/app/[locale]/not-found.tsx:
    - Locale-aware 404 page using translated strings

  apps/web/src/components/locale-switcher/locale-switcher.tsx:
    - Custom dropdown matching DOS design system
    - Uses routing.locales as source of truth (no duplication)
    - Runtime locale validation with fallback
    - ARIA attributes: aria-expanded, aria-haspopup, aria-label, role=listbox/option
    - Escape key to close, outside click to close
    - Emoji flags for PT-BR and EN-US

  apps/web/src/lib/formatters.ts:
    - formatDate(date, locale): dd/MM/yyyy (PT-BR) | MM/dd/yyyy (EN-US)
    - formatDateTime(date, locale): with time component
    - formatCurrency(amount, currency, locale): R$ 1.234,56 | $1,234.56
    - formatNumber(n, locale, options?): locale-aware number formatting
    - formatRelativeTime(date, locale): "há 2 horas" | "2 hours ago"

  apps/web/messages/pt-BR.json:
    - Source of truth with 8 namespaces: common (24 keys), nav (10),
      agents (18), office (8), approvals (14), workflows (13),
      strategy (14), settings (16)

  apps/web/messages/en-US.json:
    - English translations matching all PT-BR keys

  packages/tsconfig/nextjs.json:
    - Added "dom" and "dom.iterable" to lib (required for client components)

  next.config.mjs:
    - Added createNextIntlPlugin wrapper

  .env.example:
    - Updated Clerk URLs with /pt-BR locale prefix

FILES CREATED (13 new, 6 modified):
  New:
    apps/web/src/i18n/routing.ts
    apps/web/src/i18n/request.ts
    apps/web/src/i18n/navigation.ts
    apps/web/src/app/[locale]/layout.tsx
    apps/web/src/app/[locale]/page.tsx
    apps/web/src/app/[locale]/not-found.tsx
    apps/web/src/app/[locale]/(public)/sign-in/[[...sign-in]]/page.tsx
    apps/web/src/app/[locale]/(public)/sign-up/[[...sign-up]]/page.tsx
    apps/web/src/app/not-found.tsx
    apps/web/src/components/locale-switcher/locale-switcher.tsx
    apps/web/src/lib/formatters.ts
    apps/web/messages/pt-BR.json
    apps/web/messages/en-US.json
  Modified:
    apps/web/src/app/layout.tsx (stripped to pass-through)
    apps/web/src/middleware.ts (combined Clerk + next-intl)
    apps/web/next.config.mjs (createNextIntlPlugin)
    apps/web/package.json (added next-intl)
    packages/tsconfig/nextjs.json (added dom lib)
    .env.example (locale-aware Clerk URLs)
  Moved:
    apps/web/src/app/page.tsx → apps/web/src/app/[locale]/page.tsx
    apps/web/src/app/(public)/ → apps/web/src/app/[locale]/(public)/

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (2):
    1. Clerk sign-in/sign-up env vars pointed to bare /sign-in (no locale prefix)
       → Updated .env.example to /pt-BR/sign-in, passed signInUrl/signUpUrl
         dynamically to ClerkProvider based on current locale
    2. Middleware intl response could discard Clerk auth headers — intlMiddleware
       created new NextResponse after auth.protect() already ran
       → Return intlMiddleware(req) from clerkMiddleware callback so Clerk
         decorates the intl response with auth headers

  HIGH (3):
    3. <html> tag had no lang attribute — root layout rendered HTML shell without
       locale access → Moved <html>/<body> to [locale]/layout.tsx, root layout
       is now a pass-through that only renders {children}
    4. No not-found.tsx anywhere — notFound() call on invalid locale showed
       unstyled default 404 → Created both root and locale-aware 404 pages
    6. Sign-in/sign-up pages lacked forceRedirectUrl — Clerk redirected to
       bare / after auth → Added forceRedirectUrl={`/${locale}`} to both
       SignIn and SignUp components

  MEDIUM (3):
    7. Public routes missing /:locale root path → Added to matcher
    8. Unsafe type assertion useLocale() as Locale → Added runtime guard
       with fallback to defaultLocale
    9. Duplicated LOCALES array in LocaleSwitcher → Changed to use
       routing.locales as single source of truth

  LOW (3):
    11. Dynamic import without try/catch → Added fallback to default locale
    14. No generateStaticParams → Added for SSG support
    17. Missing ARIA attributes on LocaleSwitcher → Added aria-expanded,
        aria-haspopup, aria-label, role=listbox/option, Escape key handler

  ALSO FIXED DURING CODING:
    - packages/tsconfig/nextjs.json missing "dom" and "dom.iterable" lib entries
      (required for client component DOM APIs like document, Node, HTMLElement)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - All pages moved under [locale] dynamic segment
  - <html lang={locale}> renders with correct locale
  - 117 translation keys across 8 namespaces in both locales
  - Formatters use Intl API for locale-aware date/number/currency
  - ClerkProvider receives locale-aware URLs


================================================================================
COMMIT #15 — Epic P0-9: tRPC Router & Socket.IO
================================================================================
Hash:     dd5f66d
Date:     2026-02-24 ~24:00 -0300
Tasks:    P0-9.1 through P0-9.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  apps/web/src/app/api/trpc/[trpc]/route.ts:
    - tRPC v11 fetch handler for Next.js App Router
    - createTRPCContext with Clerk auth() userId
    - x-project-id header forwarded to context
    - Exports GET + POST handlers

  apps/web/src/lib/trpc/client.ts:
    - createTRPCReact<AppRouter>() with explicit ReturnType annotation
      (fixes TS2742 non-portable inferred type error)

  apps/web/src/lib/trpc/server.ts:
    - Server-side caller for RSC: appRouter.createCaller(ctx)
    - Cached via React.cache() to deduplicate within single request
    - Reads x-project-id from headers()

  apps/web/src/lib/trpc/provider.tsx:
    - TRPCProvider wrapping children with QueryClientProvider
    - httpBatchLink with superjson transformer
    - Reads projectId from Zustand localStorage (JSON.parse in try/catch)
    - staleTime: 30s, refetchOnWindowFocus: false

  packages/api/src/root.ts:
    - Merges 7 domain routers: agents, projects, actionLogs, approvals,
      workflows, strategies, users
    - Exports AppRouter type + appRouter instance

  packages/api/src/routers/agents.ts:
    - list, getById, create, update, delete, updateStatus, trigger
    - All scoped to ctx.project via projectProcedure/adminProcedure
    - trigger uses adminProcedure (prevents unauthorized agent execution)

  packages/api/src/routers/projects.ts:
    - list (by org), getById, create, update
    - Scoped to ctx.org via protectedProcedure

  packages/api/src/routers/action-logs.ts:
    - list (paginated with cursor, type/agentId/date filters)
    - getById
    - Uses gte/lte from drizzle-orm for date range filtering

  packages/api/src/routers/approvals.ts:
    - listPending, approve, reject
    - approve/reject use adminProcedure with reviewer tracking

  packages/api/src/routers/workflows.ts:
    - list, getById, create, update, delete, trigger
    - trigger creates workflow_runs row (adminProcedure)

  packages/api/src/routers/strategies.ts:
    - list, getById, create, update, refineWithAI, addLearning
    - addLearning uses adminProcedure (fixed from projectProcedure)
    - confidence field: number→String() for numeric DB column
    - refineWithAI: stub returning {enqueued: true} (TODO: BullMQ job)

  packages/api/src/routers/users.ts:
    - getCurrent, updateLocale, updateTimezone
    - protectedProcedure (any authenticated user can update own settings)

  packages/api/src/trpc.ts:
    - Added AuthUser, AuthOrg, AuthProject narrowed types
    - enforceAuth/enforceProject assign typed local vars before next()
    - Note: tRPC v11 doesn't propagate narrowed types through chained
      .use() middleware — routers use non-null assertions (!) as pragmatic
      workaround (runtime safety guaranteed by middleware)

  apps/worker/src/socket/server.ts:
    - Socket.IO server attached to worker HTTP server
    - JWT verified via @clerk/backend verifyToken() (not base64 decode)
    - User lookup after auth to get orgId + role for authorization
    - subscribe:project: verifies project belongs to user's org via DB query
    - trigger:agent: requires admin+ role (ROLE_HIERARCHY check)
    - CORS: explicit origin allowlist (localhost:3000/3001 + WEB_URL env)
    - emitToProject(): typed helper for broadcasting to project rooms

  packages/realtime/src/events.ts:
    - 12 server→client events: agent:status_changed, agent:action,
      agent:session_started, agent:session_complete, agent:error,
      approval:requested, approval:resolved, workflow:started,
      workflow:node_complete, workflow:complete, kpi:updated, learning:new
    - 2 client→server events: subscribe:project, trigger:agent
    - Typed interfaces for all event payloads
    - SERVER_EVENTS and CLIENT_EVENTS const maps

  apps/web/src/hooks/use-socket.ts:
    - useSocket(projectId): global singleton with Clerk auth token
    - Reference counting for cleanup (disconnect when count reaches 0)
    - Reconnection: 5 attempts, 1s delay, websocket+polling
    - useSocketEvent(event, handler): subscribes to typed events
    - Handles race condition: polls for socket if not yet connected
    - Re-subscribes on reconnect to catch missed events

FILES CREATED (14 new, 9 modified):
  New:
    apps/web/src/app/api/trpc/[trpc]/route.ts
    apps/web/src/lib/trpc/client.ts
    apps/web/src/lib/trpc/server.ts
    apps/web/src/lib/trpc/provider.tsx
    apps/web/src/hooks/use-socket.ts
    apps/worker/src/socket/server.ts
    packages/api/src/routers/agents.ts
    packages/api/src/routers/projects.ts
    packages/api/src/routers/action-logs.ts
    packages/api/src/routers/approvals.ts
    packages/api/src/routers/workflows.ts
    packages/api/src/routers/strategies.ts
    packages/api/src/routers/users.ts
    packages/realtime/src/events.ts
  Modified:
    packages/api/src/root.ts (merged 7 domain routers)
    packages/api/src/trpc.ts (narrowed types, typed locals)
    packages/realtime/src/index.ts (barrel exports for events)
    apps/web/src/app/[locale]/layout.tsx (added TRPCProvider)
    apps/web/package.json (added @tanstack/react-query, @trpc/client, @trpc/react-query, @trpc/server, socket.io-client)
    apps/worker/package.json (added socket.io, @clerk/backend)
    apps/worker/src/index.ts (Socket.IO server creation)
    apps/worker/src/workers/create-worker.ts (ZodType generic fix)
    pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. Socket.IO JWT not verified — just base64 decoded without signature check
       → Installed @clerk/backend, replaced with verifyToken() using
         CLERK_SECRET_KEY (fails on expired/tampered tokens)
    2. No project authorization on subscribe:project — any authenticated user
       could subscribe to any project room (cross-tenant data leak)
       → Added DB query: verify project.orgId matches socket.data.orgId
    3. No authorization on trigger:agent — any user could trigger agent execution
       → Added ROLE_HIERARCHY check requiring admin+ role

  HIGH (5):
    4. CORS origin undefined in production — process.env.NEXT_PUBLIC_SOCKET_URL
       gate was inverted, production would have undefined origin
       → Changed to explicit getAllowedOrigins() returning localhost + WEB_URL
    5. JSON.parse in provider.tsx could throw on corrupted localStorage,
       crashing all tRPC requests → Wrapped in try/catch with fallback
    6. Socket never disconnects — components unmount but global socket stays open
       with stale auth tokens → Added reference counting, disconnect when count=0
    7. useSocketEvent misses events if socket not yet connected (race condition)
       → Added polling interval + re-subscribe on reconnect event
    8. strategies.addLearning used projectProcedure (any project member could add)
       → Changed to adminProcedure

  ALSO FIXED:
    - ZodSchema<T> in createTypedWorker didn't accept schemas with .default()
      (input type differs from output type) → Changed to ZodType<T, ZodTypeDef, unknown>
    - tRPC v11 middleware type narrowing: chained .use() doesn't propagate
      NonNullable types → Pragmatic solution: non-null assertions (!) in routers
    - socket.io-client generic type complexity → Minimal any casts on .on/.off
    - createCallerFactory not exported from @trpc/server → Used appRouter.createCaller()
    - TS2742 non-portable inferred type → Explicit ReturnType annotation on trpc client
    - strategies confidence: number input vs string DB column → String(confidence)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - JWT verified with @clerk/backend verifyToken (cryptographic check)
  - Project access verified via DB query (org isolation)
  - Agent trigger requires admin+ role
  - Socket cleanup on unmount (reference counting)
  - 7 domain routers covering all 15 DB tables
  - 14 typed Socket.IO events with const maps


================================================================================
COMMIT #17 — Epic P0-10: UI Shell & Base Layout
================================================================================
Hash:     dd1863f
Date:     2026-02-25 ~01:00 -0300
Tasks:    P0-10.1 through P0-10.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  apps/web/src/components/ui/:
    - Button: primary/secondary/ghost/danger variants, sm/md/lg sizes
    - Input: dark theme, focus ring, disabled state
    - Skeleton: animated pulse placeholder
    - Tooltip: hover + focus/blur (keyboard accessible), delayed show (200ms),
      timeout cleared on unmount, 4 position sides, useId for a11y
    - Separator: horizontal/vertical with aria-orientation
    - Badge: default/warning/success/error/cyan variants
    - index.ts barrel export

  apps/web/src/stores/ui-store.ts:
    - Zustand store for sidebarCollapsed + railCollapsed
    - persist middleware with partialize (only data, no functions)
    - skipHydration: true (rehydrated in AppShell useEffect)

  apps/web/src/components/layout/app-shell.tsx:
    - AppShell: flex layout with ProjectRail + RailExpandButton + Sidebar +
      Header + main content area
    - Rehydrates both project-store and ui-store on client mount

  apps/web/src/components/layout/sidebar.tsx:
    - 11 nav items with lucide-react icons
    - Items: Office, ATLAS*, Agents, Workflows*, DevOps*, Approvals (badge),
      Strategy*, Memory, Tools, Analytics*, Settings (*=Coming Soon)
    - Collapsed mode: 52px with Tooltip on each item
    - Expanded mode: 220px with label + badges
    - Uses CSS custom properties for widths (--width-sidebar-*)
    - Active route: cyan left border + bg-overlay highlight
    - i18n labels via useTranslations('nav')
    - aria-label on <nav> element
    - Collapse/expand toggle button with ChevronLeft/ChevronRight

  apps/web/src/components/layout/project-rail.tsx:
    - ProjectRail: colored project squares from Zustand store
    - Active project: color border + left indicator bar
    - Tooltip on each project icon (hover + focus)
    - "+" button for new project
    - Collapsed by default (width: 0, overflow: hidden)
    - RailExpandButton: separate component visible when collapsed
    - project.color sanitized via safeColor() hex validation
    - Collapse toggle only rendered when expanded (not clipped by overflow)

  apps/web/src/components/layout/header.tsx:
    - Breadcrumb: project name (colored) / page name (from route)
    - Search stub: Cmd+K (Mac) / Ctrl+K (Win/Linux), platform detected via useEffect
    - Notification bell with pulse indicator for pending approvals
    - LocaleSwitcher (existing component)
    - Company/Project switcher dropdown:
      - Lists all projects with colored squares
      - "ativo"/"active" indicator on current project
      - Outside click + Escape key to close
      - ARIA: aria-expanded, aria-haspopup, role=listbox, role=option
    - Clerk UserButton with 24px avatar

  apps/web/src/lib/safe-color.ts:
    - safeColor(color): validates hex pattern /^#[0-9a-fA-F]{3,8}$/
    - Returns fallback #6E7681 on invalid input (prevents CSS injection)

  apps/web/src/components/shared/coming-soon.tsx:
    - Placeholder component for feature-flagged routes
    - Shows Construction icon + translated title + "Coming Soon" badge

  apps/web/src/app/[locale]/(auth)/layout.tsx:
    - Auth layout wrapping children with AppShell

  apps/web/src/app/[locale]/(auth)/*/page.tsx:
    - 11 route pages: office, atlas, agents, workflows, devops, approvals,
      strategy, memory, tools, analytics, settings
    - Active routes: placeholder with translated title
    - Coming-soon routes: ComingSoon component

  apps/web/src/app/[locale]/page.tsx:
    - Root page redirects to /{locale}/office

  apps/web/messages/pt-BR.json + en-US.json:
    - Added 10 new nav keys: atlas, devops, memory, tools, comingSoon,
      companies, newProject, active, collapseNav, expandNav,
      searchPlaceholder, notifications

FILES CREATED (25 new, 3 modified):
  New:
    apps/web/src/components/ui/button.tsx
    apps/web/src/components/ui/input.tsx
    apps/web/src/components/ui/skeleton.tsx
    apps/web/src/components/ui/tooltip.tsx
    apps/web/src/components/ui/separator.tsx
    apps/web/src/components/ui/badge.tsx
    apps/web/src/components/ui/index.ts
    apps/web/src/stores/ui-store.ts
    apps/web/src/components/layout/app-shell.tsx
    apps/web/src/components/layout/sidebar.tsx
    apps/web/src/components/layout/project-rail.tsx
    apps/web/src/components/layout/header.tsx
    apps/web/src/components/shared/coming-soon.tsx
    apps/web/src/lib/safe-color.ts
    apps/web/src/app/[locale]/(auth)/layout.tsx
    apps/web/src/app/[locale]/(auth)/office/page.tsx
    apps/web/src/app/[locale]/(auth)/atlas/page.tsx
    apps/web/src/app/[locale]/(auth)/agents/page.tsx
    apps/web/src/app/[locale]/(auth)/workflows/page.tsx
    apps/web/src/app/[locale]/(auth)/devops/page.tsx
    apps/web/src/app/[locale]/(auth)/approvals/page.tsx
    apps/web/src/app/[locale]/(auth)/strategy/page.tsx
    apps/web/src/app/[locale]/(auth)/memory/page.tsx
    apps/web/src/app/[locale]/(auth)/tools/page.tsx
    apps/web/src/app/[locale]/(auth)/analytics/page.tsx
    apps/web/src/app/[locale]/(auth)/settings/page.tsx
  Modified:
    apps/web/src/app/[locale]/page.tsx (redirect to /office)
    apps/web/messages/pt-BR.json (10 new nav keys)
    apps/web/messages/en-US.json (10 new nav keys)

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  HIGH (7):
    1. Tooltip: setTimeout not cleared on unmount (memory leak)
       → Added cleanup useEffect
    2. Tooltip: inaccessible to keyboard users (no focus/blur)
       → Added onFocus/onBlur handlers, useId for ARIA
    3. project.color used directly in inline styles (CSS injection risk)
       → Created safeColor() with hex regex validation + fallback
    4. Header project dropdown: no Escape key handling
       → Added keydown listener for Escape alongside mousedown
    5. ui-store: persist serialized functions to localStorage
       → Added partialize to only persist data fields
    6. Sidebar: React key on wrong element in .map()
       → Moved key to outermost wrapper in both branches
    7. Header: search shortcut hardcodes macOS ⌘ glyph
       → Added platform detection useEffect, shows Ctrl+K on Win/Linux

  MEDIUM (5):
    8. Project rail toggle: icon didn't change based on state
       → Only render toggle when expanded, RailExpandButton handles collapsed
    9. Project rail toggle: clipped by overflow:hidden when collapsed
       → Conditionally render with {!collapsed && ...}
    10. RailExpandButton: missing aria-label
        → Added translated aria-label
    12. Sidebar <nav>: missing aria-label landmark
        → Added aria-label="Main navigation"
    14. Separator: missing aria-orientation
        → Added aria-orientation={orientation}

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - 11 routes under (auth) group with AppShell wrapper
  - Sidebar: 11 nav items, 5 with "Coming Soon" badge
  - All project colors sanitized before inline style injection
  - Tooltip accessible via keyboard (focus/blur + hover)
  - Escape key closes dropdowns (header project switcher)
  - Platform-aware keyboard shortcut display


================================================================================
COMMIT #18 — Epic P1-1: WhatsApp Business API Integration
================================================================================
Hash:     (pending)
Date:     2026-02-25 ~02:30 -0300
Tasks:    P1-1.1 through P1-1.5 (5 tasks: schema, provider client, tools, webhook, tRPC router)
================================================================================

WHAT WAS BUILT:
  packages/db/src/schema/enums.ts:
    - 5 new enums: whatsappProviderEnum (zapi, twilio, meta_cloud),
      whatsappConnectionStatusEnum, whatsappMessageDirectionEnum,
      whatsappMessageStatusEnum (pending, sent, delivered, read, failed),
      whatsappTemplateStatusEnum

  packages/db/src/schema/whatsapp.ts:
    - whatsappConnections: one per project, provider, encrypted apiCredentials
      (union type: plaintext | {encrypted: string}), phoneNumber, handlerAgentId,
      status, unique index on projectId
    - whatsappMessages: inbound + outbound, direction, status, contactPhone,
      contactName, content, mediaUrl, providerMessageId, rawPayload, agentId,
      4 indexes (project, contact, agent, sentAt)
    - whatsappTemplates: templateName, language, content, status,
      providerTemplateId, unique index on (projectId, templateName)

  packages/ai/src/tools/whatsapp/client.ts — Provider abstraction:
    - WhatsAppClient interface: sendMessage() + getConnectionStatus()
    - ZApiClient: send-text/send-image endpoints, AbortSignal.timeout(15s)
      NOTE: Z-API embeds token in URL path (provider design, logged in access logs)
    - TwilioClient: Messages.json API with Basic auth, validates non-empty
      fromNumber in constructor, AbortSignal.timeout(15s)
    - MetaCloudClient: Graph API v21.0, Bearer auth, AbortSignal.timeout(15s)
    - createWhatsAppClient() factory function

  packages/ai/src/tools/whatsapp/send.ts:
    - send_whatsapp_message tool (requiresApproval: true)
    - E.164 phone validation, connection lookup, status check
    - Inserts message with 'pending' status BEFORE sending
    - Decrypts credentials if stored encrypted
    - Provider call wrapped in try/catch: updates to 'failed' on error
    - Updates to 'sent' on success with providerMessageId

  packages/ai/src/tools/whatsapp/read.ts:
    - read_whatsapp_messages tool (no approval needed)
    - E.164 validation on contactPhone
    - Returns messages in chronological order (oldest first)

  apps/web/src/app/api/webhooks/whatsapp/route.ts:
    - GET: Meta webhook verification challenge
    - POST: Multi-provider webhook receiver with signature verification:
      - Meta Cloud API: HMAC-SHA256 via x-hub-signature-256 header
      - Twilio: HMAC-SHA1 via x-twilio-signature header
      - Z-API: Bearer token via Authorization header
      - All use timingSafeEqual to prevent timing attacks
    - Provider detection from payload shape
    - Multi-tenant connection matching: by businessPhone first (extracted
      from Meta display_phone_number / Twilio To field), then by provider
      type only if exactly one connection exists (no connections[0] fallback)
    - Safe timestamp parsing (Unix epoch, ISO string, fallback to now)
    - Inbound messages stored with 'delivered' status (not 'sent')
    - DB insert wrapped in try/catch (returns 200 even on failure to
      prevent infinite provider retries)
    - Enqueues agent execution if handlerAgentId configured

  packages/api/src/routers/whatsapp.ts — tRPC router (6 procedures):
    - getConnection: projectProcedure, strips apiCredentials
    - saveConnection: adminProcedure, encrypts credentials with AES-256-GCM
      before storing, sanitizes response (no credentials returned)
    - updateConnectionStatus: adminProcedure, verifies credentials work
      via provider getConnectionStatus() before allowing 'connected' status,
      sanitizes response
    - listTemplates, createTemplate, updateTemplate, deleteTemplate
    - listMessages: cursor-based pagination (fetches messages older than
      cursor's sentAt timestamp)

  packages/shared/src/utils/crypto.ts — NEW FILE:
    - AES-256-GCM encrypt/decrypt using CREDENTIALS_ENCRYPTION_KEY env var
    - Format: base64(iv[12B] + ciphertext + authTag[16B])
    - Key validation: must be 64 hex chars (32 bytes)

FILES CREATED (8 new, 11 modified):
  New:
    packages/db/src/schema/whatsapp.ts
    packages/ai/src/tools/whatsapp/client.ts
    packages/ai/src/tools/whatsapp/send.ts
    packages/ai/src/tools/whatsapp/read.ts
    packages/ai/src/tools/whatsapp/index.ts
    apps/web/src/app/api/webhooks/whatsapp/route.ts
    packages/api/src/routers/whatsapp.ts
    packages/shared/src/utils/crypto.ts
  Modified:
    packages/db/src/schema/enums.ts (5 WhatsApp enums)
    packages/db/src/schema/index.ts (whatsapp export)
    packages/db/src/index.ts (added lt, gt, gte, lte operators)
    packages/ai/src/tools/registry.ts (WhatsApp tools registered)
    packages/ai/src/index.ts (WhatsApp barrel exports)
    packages/api/src/root.ts (whatsapp router added)
    packages/api/package.json (added @ai-office/ai dependency)
    packages/shared/package.json (added @types/node)
    packages/shared/tsconfig.json (added types: ["node"])
    packages/shared/src/utils/index.ts (crypto exports)
    apps/web/package.json (added @ai-office/queue dependency)

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (4):
    1. Webhook had NO signature verification — anyone could inject fake messages
       → Added verifyMetaSignature (HMAC-SHA256), verifyTwilioSignature (HMAC-SHA1),
         verifyZApiToken (Bearer header), all using timingSafeEqual
    2. Multi-tenant connection matching broken — matched by provider type,
       fell back to connections[0] (cross-tenant message injection)
       → Match by businessPhone first (Meta display_phone_number, Twilio To),
         then by provider only if single connection exists, no fallback
    3. saveConnection returned full row including plaintext apiCredentials
       → Added sanitizeConnection() helper, strips credentials from all responses
    4. API credentials stored in plaintext in DB
       → AES-256-GCM encryption via CREDENTIALS_ENCRYPTION_KEY env var,
         new packages/shared/src/utils/crypto.ts

  HIGH (8):
    5. Send tool wrote status 'sent' BEFORE actually sending
       → Insert with 'pending', update to 'sent'/'failed' after
    6. No timeout on provider HTTP calls (hang forever)
       → AbortSignal.timeout(15_000) on all fetch calls
    7. updateConnectionStatus allowed 'connected' without credential verification
       → Decrypts credentials, calls provider getConnectionStatus(), rejects if failed
    8. Webhook timestamp parsing could produce Invalid Date
       → safeParseTimestamp: handles Unix epoch, ISO string, fallback to now()
    9. listMessages cursor pagination declared but not implemented
       → Cursor-based pagination using lt(sentAt) from cursor message
    10. Send tool didn't catch provider exceptions (network timeout, etc.)
        → Wrapped in try/catch, updates message to 'failed' on any error
    11. TwilioClient accepted empty string as fromNumber
        → Constructor throws if phoneNumber is empty
    12. Z-API token in URL path logged in access logs
        → Added comment explaining Z-API design constraint (not fixable)

  ALSO FIXED DURING CODING:
    - Added @types/node to @ai-office/shared (crypto module)
    - Added types: ["node"] to shared tsconfig.json
    - Added @ai-office/ai dependency to @ai-office/api package
    - Added lt, gt, gte, lte to @ai-office/db drizzle-orm re-exports
    - Updated whatsapp schema $type to accept encrypted credentials union
    - Send tool decrypts credentials if stored in encrypted format
    - Fixed webhook self-comparison bug (c.phoneNumber === c.phoneNumber)
    - Inbound messages default to 'delivered' status (not 'sent')

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - All 3 providers have signature verification (Meta, Twilio, Z-API)
  - Credentials encrypted at rest with AES-256-GCM
  - Connection matching uses phone number (multi-tenant safe)
  - Provider calls have 15s timeout
  - Send tool: pending → sent/failed state machine
  - Cursor-based pagination implemented for listMessages
  - DB insert failures in webhook don't cause 5xx (always return 200)


================================================================================
COMMIT #19 — Epic P1-1.6: WhatsApp Connection Setup UI
================================================================================
Hash:     (pending)
Date:     2026-02-25 ~03:00 -0300
Tasks:    P1-1.6 (WhatsApp settings UI)
================================================================================

WHAT WAS BUILT:
  apps/web/src/app/[locale]/(auth)/settings/page.tsx — REWRITTEN:
    - Tabbed layout matching prototype DOS aesthetic
    - Left sidebar (w-44) with 3 tabs: General, Team, Integrations
    - Tab icons: Building2, Users, Puzzle (lucide-react)
    - Active tab: left cyan border + cyan bg/text; inactive: transparent/muted
    - General + Team tabs render ComingSoon component (Phase 3)
    - Integrations tab renders WhatsAppPanel

  apps/web/src/app/[locale]/(auth)/settings/_components/whatsapp-panel.tsx — NEW:
    - Header row: WhatsApp icon box + title/description + status Badge + phone
    - Provider toggle: 3-button group (Z-API | Twilio | Meta Cloud API)
    - Conditional credential fields per provider:
      - Z-API: Instance ID + Token (password)
      - Twilio: Account SID + Auth Token (password)
      - Meta Cloud: Phone Number ID + Access Token (password)
    - Phone number input (E.164 format placeholder)
    - Handler agent <select> populated from trpc.agents.list
    - Action buttons: Save Connection (primary), Verify Connection (secondary,
      hidden when connected), Disconnect (danger, shown when connected)
    - Inline feedback: success/error messages below buttons
    - Loading: Skeleton components during initial query
    - Mutation states: buttons disabled + "Saving..."/"Verifying..." text
    - tRPC calls: getConnection, saveConnection, updateConnectionStatus, agents.list
    - Cache invalidation on mutation success via trpc.useUtils()

  apps/web/messages/pt-BR.json + en-US.json:
    - Added settings.subtitle key
    - Added settings.whatsapp.* namespace (28 keys each):
      title, description, provider labels, credential labels, phone number,
      handler agent, action buttons, status labels, feedback messages

FILES CREATED (1 new, 3 modified):
  New:
    apps/web/src/app/[locale]/(auth)/settings/_components/whatsapp-panel.tsx
  Modified:
    apps/web/src/app/[locale]/(auth)/settings/page.tsx (tabbed layout rewrite)
    apps/web/messages/pt-BR.json (settings.whatsapp namespace)
    apps/web/messages/en-US.json (settings.whatsapp namespace)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Settings page renders tabbed layout with sidebar
  - Integrations tab shows WhatsApp config panel
  - Provider toggle switches credential fields
  - Save/Verify/Disconnect flow calls correct tRPC mutations


================================================================================
COMMIT #7 — Task P1-2.5: Web Search Tool (Serper API + Redis Cache)
================================================================================
Date:     2026-02-24
Tasks:    P1-2.5 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - search_web agent tool: Google Search via Serper API with Redis caching
  - Shared Redis client singleton reusable across packages
  - Fully integrated into existing tool registry

DETAILS:
  packages/queue/src/redis.ts (NEW):
    - getRedisClient() singleton using { Redis } from 'ioredis'
    - Parses REDIS_URL env var (same as BullMQ queues)
    - lazyConnect: true for deferred connection
    - Exported from packages/queue/src/index.ts

  packages/ai/src/tools/web-search/search.ts (NEW):
    - Tool name: search_web
    - Input schema: { query (required), numResults? (1-20, default 5), locale? (default 'pt-BR') }
    - requiresApproval: false (read-only)
    - Cache: SHA-256 hash key, 1h TTL in Redis
    - API: POST https://google.serper.dev/search with X-API-KEY header
    - Response: extracts organic results → { title, url, snippet, position }
    - 10s fetch timeout via AbortSignal.timeout()
    - Graceful handling: missing API key returns setup instructions,
      Redis errors are non-fatal, API errors include status + body

  packages/ai/src/tools/web-search/index.ts (NEW):
    - Barrel export for searchWebTool

  packages/ai/src/tools/registry.ts (MODIFIED):
    - Imported and registered searchWebTool

  packages/ai/src/index.ts (MODIFIED):
    - Added barrel export for searchWebTool

  packages/ai/package.json (MODIFIED):
    - Added @ai-office/queue workspace dependency

FILES CREATED (3 new, 4 modified):
  New:
    packages/queue/src/redis.ts
    packages/ai/src/tools/web-search/search.ts
    packages/ai/src/tools/web-search/index.ts
  Modified:
    packages/queue/src/index.ts
    packages/ai/src/tools/registry.ts
    packages/ai/src/index.ts
    packages/ai/package.json

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Tool registered in toolRegistry, available to all agents
  - Env var: SERPER_API_KEY required at runtime


================================================================================
COMMIT #8 — Task P1-2.1: send_email Tool (Nodemailer SMTP + Provider Abstraction)
================================================================================
Date:     2026-02-24
Tasks:    P1-2.1 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - send_email agent tool: SMTP via Nodemailer with provider abstraction
  - Email DB schema: connections, messages, templates (3 tables, 4 enums)
  - tRPC router for email connection management and templates
  - CAN-SPAM/LGPD compliance headers for marketing emails
  - Security: SSRF protection on attachments, header injection prevention

DETAILS:
  packages/db/src/schema/enums.ts (MODIFIED):
    - Added emailProviderEnum (smtp, sendgrid, aws_ses)
    - Added emailConnectionStatusEnum, emailMessageStatusEnum, emailMessageTypeEnum

  packages/db/src/schema/email.ts (NEW):
    - emailConnections: one per project, encrypted credentials (jsonb), fromEmail/fromName/replyTo
    - emailMessages: audit trail with status, recipients (text[]), subject, bodyHtml, bodyText,
      custom headers, attachments (jsonb), providerMessageId, error, sentAt
    - emailTemplates: reusable templates with name (unique per project), messageType, isActive

  packages/ai/src/tools/email/client.ts (NEW):
    - EmailProvider type: smtp, sendgrid, aws_ses
    - SmtpClient: Nodemailer createTransport with 15s timeouts, sendEmail(), verifyConnection()
    - SendGridClient / AwsSesClient: stubs returning "not yet implemented"
    - createEmailClient() factory function

  packages/ai/src/tools/email/send.ts (NEW):
    - Tool name: send_email, requiresApproval: true
    - Input: { to, subject, body (HTML), cc?, bcc?, isMarketing?, attachments? }
    - SSRF protection: attachment URLs must be HTTPS, no private IPs/localhost
    - Header injection prevention: sanitizeDisplayName strips \r\n<>
    - Auto-generates plaintext body from HTML for spam prevention
    - Marketing emails get List-Unsubscribe header (mailto: form)
    - Audit trail: inserts pending message, updates with result

  packages/ai/src/tools/email/index.ts (NEW):
    - Barrel export for client types and sendEmailTool

  packages/api/src/routers/email.ts (NEW):
    - getConnection (projectProcedure): returns sanitized connection
    - saveConnection (adminProcedure): encrypts credentials, upserts
    - updateConnectionStatus (adminProcedure): SMTP verify before connecting
    - listTemplates, createTemplate, updateTemplate, deleteTemplate
    - listMessages: cursor-based pagination by createdAt

  packages/ai/src/tools/registry.ts (MODIFIED):
    - Imported and registered sendEmailTool

  packages/ai/src/index.ts (MODIFIED):
    - Added barrel exports for email client, tool, and types

  packages/ai/package.json (MODIFIED):
    - Added nodemailer + @types/nodemailer

  packages/api/src/root.ts (MODIFIED):
    - Registered emailRouter

FILES CREATED (5 new, 6 modified):
  New:
    packages/db/src/schema/email.ts
    packages/ai/src/tools/email/client.ts
    packages/ai/src/tools/email/send.ts
    packages/ai/src/tools/email/index.ts
    packages/api/src/routers/email.ts
  Modified:
    packages/db/src/schema/enums.ts
    packages/db/src/schema/index.ts
    packages/ai/src/tools/registry.ts
    packages/ai/src/index.ts
    packages/ai/package.json
    packages/api/src/root.ts

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Tool registered in toolRegistry
  - tRPC router: trpc.email.* (9 procedures)
  - Security review: SSRF blocked, header injection prevented
  - Env vars: CREDENTIALS_ENCRYPTION_KEY (existing), SMTP creds via Settings UI


================================================================================
COMMIT #9 — Task P1-2.2: read_email Tool (IMAP via imapflow)
================================================================================
Hash:     a7ea537
Date:     2026-02-24
Tasks:    P1-2.2 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - read_email agent tool: IMAP inbox reading via imapflow library
  - Agents can read recent emails with optional query, limit, and unread filter
  - IMAP credentials fall back to existing SMTP host/user/pass with optional overrides
  - Read-only tool — no approval required

DETAILS:
  packages/db/src/schema/email.ts (MODIFIED):
    - Added imapHost?, imapPort?, imapSecure? to apiCredentials jsonb type
    - TypeScript-only change on jsonb column — no migration needed

  packages/ai/src/tools/email/client.ts (MODIFIED):
    - Added ReadEmailParams, EmailMessage, ReadEmailResult interfaces
    - Added readEmails() to EmailClient interface
    - SmtpClient.readEmails(): connects to IMAP (defaults to SMTP host, port 993,
      secure true), searches INBOX, fetches envelope + body part 1, returns
      up to `limit` most recent emails in chronological order
    - Added ImapFlow import, IMAP_DEFAULT_PORT (993), MAX_BODY_LENGTH (4000)
    - SmtpCredentials extended with imapHost?, imapPort?, imapSecure?
    - SendGridClient/AwsSesClient: stub readEmails() returning unsupported error
    - SmtpClient stores credentials ref for IMAP reuse

  packages/ai/src/tools/email/read.ts (NEW):
    - Tool name: read_email, requiresApproval: false (read-only)
    - Input: { query? (search subject/from/body), limit? (1-50, default 20),
      unreadOnly? (boolean) }
    - Looks up project emailConnection, decrypts credentials, creates client
    - Returns { emailCount, emails: [{ from, subject, body, date, isRead, messageId }] }

  packages/ai/src/tools/email/index.ts (MODIFIED):
    - Added exports: readEmailTool, ReadEmailParams, ReadEmailResult, EmailMessage

  packages/ai/src/tools/registry.ts (MODIFIED):
    - Imported and registered readEmailTool

  packages/ai/src/index.ts (MODIFIED):
    - Added barrel exports for readEmailTool and read-related types

  packages/ai/package.json (MODIFIED):
    - Added imapflow@^1.0.0 dependency

FILES CREATED (1 new, 6 modified):
  New:
    packages/ai/src/tools/email/read.ts
  Modified:
    packages/db/src/schema/email.ts
    packages/ai/src/tools/email/client.ts
    packages/ai/src/tools/email/index.ts
    packages/ai/src/tools/registry.ts
    packages/ai/src/index.ts
    packages/ai/package.json

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Tool registered in toolRegistry
  - No new DB migration needed (TypeScript type change on jsonb column)
  - IMAP connection uses same credentials as SMTP with optional overrides


================================================================================
COMMIT #10 — Task P1-2.6: OAuth2 Credential Management
================================================================================
Hash:     2167fe1
Date:     2026-02-24
Tasks:    P1-2.6 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - tool_credentials DB table for encrypted OAuth2 token storage (per project + tool type)
  - OAuth2 utility: authorization URL, code exchange, token refresh (Google + RD Station)
  - tRPC router: list/getAuthUrl/exchangeCode/disconnect/refreshTokens
  - Auto-refreshing helper for tools to get valid access tokens

DETAILS:
  packages/db/src/schema/enums.ts (MODIFIED):
    - Added toolTypeEnum: google_gmail, google_sheets, rdstation_crm, rdstation_marketing

  packages/db/src/schema/tool-credentials.ts (NEW):
    - tool_credentials table: id, project_id, tool_type, access_token (encrypted),
      refresh_token (encrypted), expires_at, metadata (jsonb), timestamps
    - Unique index on (project_id, tool_type), index on expires_at

  packages/shared/src/utils/oauth2.ts (NEW):
    - getAuthorizationUrl(): builds Google/RD Station auth URL with state param
    - exchangeCodeForTokens(): exchanges auth code for access + refresh tokens
    - refreshAccessToken(): refreshes expired access token
    - GOOGLE_SCOPES / RDSTATION_SCOPES constants

  packages/api/src/routers/tool-credentials.ts (NEW):
    - list (projectProcedure): returns connections with expired status
    - getAuthUrl (adminProcedure): generates OAuth URL with state
    - exchangeCode (adminProcedure): exchanges code, encrypts + stores tokens
    - disconnect (adminProcedure): deletes credential
    - refreshTokens (adminProcedure): manual token refresh

  packages/ai/src/tools/oauth2-helper.ts (NEW):
    - getValidAccessToken(projectId, toolType): returns decrypted access token,
      auto-refreshes if within 5min of expiry

FILES CREATED (4 new, 3 modified):
  New:
    packages/db/src/schema/tool-credentials.ts
    packages/shared/src/utils/oauth2.ts
    packages/api/src/routers/tool-credentials.ts
    packages/ai/src/tools/oauth2-helper.ts
  Modified:
    packages/db/src/schema/enums.ts
    packages/db/src/schema/index.ts
    packages/api/src/root.ts

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass
  - tRPC router: trpc.toolCredentials.* (5 procedures)
  - Env vars: GOOGLE_OAUTH_CLIENT_ID, GOOGLE_OAUTH_CLIENT_SECRET, GOOGLE_OAUTH_REDIRECT_URI,
    RDSTATION_OAUTH_CLIENT_ID, RDSTATION_OAUTH_CLIENT_SECRET, RDSTATION_OAUTH_REDIRECT_URI
  - Requires Drizzle migration: drizzle-kit generate && drizzle-kit migrate


================================================================================
COMMIT #11 — Task P1-2.4: RD Station CRM Tools
================================================================================
Hash:     a87b5dd
Date:     2026-02-24
Tasks:    P1-2.4 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - 5 CRM tools for Brazil's primary SME CRM (RD Station / Plug CRM API)
  - search_contacts (read-only), create_contact (approval), update_contact (approval),
    list_deals (read-only), create_deal (approval)

DETAILS:
  packages/ai/src/tools/crm/client.ts (NEW):
    - RdStationCrmClient: REST API calls to plugcrm.net/api/v1
    - 15s fetch timeout, token-based auth
    - Typed interfaces: RdStationContact, RdStationDeal

  packages/ai/src/tools/crm/search-contacts.ts (NEW):
    - search_contacts tool: query contacts by name/email/phone
  packages/ai/src/tools/crm/create-contact.ts (NEW):
    - create_contact tool: create new lead (requires approval)
  packages/ai/src/tools/crm/update-contact.ts (NEW):
    - update_contact tool: update existing lead (requires approval)
  packages/ai/src/tools/crm/list-deals.ts (NEW):
    - list_deals tool: list pipeline deals
  packages/ai/src/tools/crm/create-deal.ts (NEW):
    - create_deal tool: create new opportunity (requires approval)
  packages/ai/src/tools/crm/index.ts (NEW):
    - Barrel export for all CRM tools and types

FILES CREATED (7 new, 2 modified):
  New:
    packages/ai/src/tools/crm/client.ts
    packages/ai/src/tools/crm/search-contacts.ts
    packages/ai/src/tools/crm/create-contact.ts
    packages/ai/src/tools/crm/update-contact.ts
    packages/ai/src/tools/crm/list-deals.ts
    packages/ai/src/tools/crm/create-deal.ts
    packages/ai/src/tools/crm/index.ts
  Modified:
    packages/ai/src/tools/registry.ts
    packages/ai/src/index.ts

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass
  - 5 tools registered in toolRegistry
  - Uses OAuth2 auto-refresh via oauth2-helper


================================================================================
COMMIT #12 — Task P1-2.3: Google Sheets Tools
================================================================================
Hash:     822fc50
Date:     2026-02-24
Tasks:    P1-2.3 (1 task, Epic P1-2: Email, Sheets & CRM Tool Integrations)
================================================================================

WHAT WAS BUILT:
  - 3 Google Sheets tools using Sheets API v4 with OAuth2
  - read_spreadsheet (read-only), write_spreadsheet (approval),
    append_to_spreadsheet (approval)

DETAILS:
  packages/ai/src/tools/sheets/client.ts (NEW):
    - GoogleSheetsClient: REST calls to sheets.googleapis.com/v4
    - readRange, writeRange, appendRows methods
    - 15s fetch timeout, Bearer token auth

  packages/ai/src/tools/sheets/read.ts (NEW):
    - read_spreadsheet: read cell range, returns 2D array
  packages/ai/src/tools/sheets/write.ts (NEW):
    - write_spreadsheet: overwrite cell range (approval)
  packages/ai/src/tools/sheets/append.ts (NEW):
    - append_to_spreadsheet: append rows to end (approval)
  packages/ai/src/tools/sheets/index.ts (NEW):
    - Barrel export

FILES CREATED (5 new, 2 modified):
  New:
    packages/ai/src/tools/sheets/client.ts
    packages/ai/src/tools/sheets/read.ts
    packages/ai/src/tools/sheets/write.ts
    packages/ai/src/tools/sheets/append.ts
    packages/ai/src/tools/sheets/index.ts
  Modified:
    packages/ai/src/tools/registry.ts
    packages/ai/src/index.ts

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass
  - 3 tools registered in toolRegistry
  - Uses OAuth2 auto-refresh via oauth2-helper


================================================================================
  EPIC P1-2 COMPLETE — All 6 tasks done (P1-2.1 through P1-2.6)
  Total tools registered: 19 (3 stubs + 2 WhatsApp + 1 web search +
    2 email + 5 CRM + 3 Sheets + 3 utility)
================================================================================


================================================================================
COMMIT #13 — P1-3.1 + P1-3.2: Document Ingestion & RAG Search
================================================================================
Hash:     a1c4670
Date:     2026-02-24
Tasks:    P1-3.1 (Document ingestion pipeline), P1-3.2 (RAG search tool)
================================================================================

WHAT WAS BUILT:
  packages/ai/src/memory/ingest.ts (NEW):
    - splitIntoChunks(): 512-token chunks with 64-token overlap
    - Sentence/paragraph boundary detection for clean splits
    - generateEmbeddings(): OpenAI text-embedding-3-small, batch of 20
    - ingestDocument(): full pipeline — split → embed → store in document_chunks
    - deleteDocument(): remove document + all chunks
  packages/ai/src/memory/rag-search.ts (NEW):
    - ragSearch(): pgvector cosine similarity search (1 - embedding <=> query)
    - generateQueryEmbedding(): single query → 1536-dim vector
    - Filters by sourceType, dateRange
    - Returns top-K results with scores and citations
  packages/ai/src/tools/registry.ts (MODIFIED):
    - Replaced search_company_memory stub with real RAG search implementation

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #14 — P1-3.5 + P1-3.6: Auto Memory & Auto Ingestion
================================================================================
Hash:     cc7fabd
Date:     2026-02-24
Tasks:    P1-3.5 (Auto memory extraction), P1-3.6 (Action log auto-ingestion)
================================================================================

WHAT WAS BUILT:
  packages/ai/src/memory/auto-extract.ts (NEW):
    - extractMemories(): LLM-based memory extraction using gpt-4o-mini
    - JSON response format for structured key-value pairs
    - autoExtractAndSave(): post-session processing pipeline
  packages/ai/src/memory/auto-ingest.ts (NEW):
    - autoIngestRecentSessions(): summarizes completed sessions
    - Ingests summaries into RAG for cross-agent knowledge sharing

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #15 — P1-4.4 + P1-5.1–P1-5.5: Archetypes & 5 BR Agents
================================================================================
Hash:     11f95a1
Date:     2026-02-24
Tasks:    P1-4.4 (Archetype system), P1-5.1–P1-5.5 (5 agent archetypes)
================================================================================

WHAT WAS BUILT:
  packages/db/src/schema/archetypes.ts (NEW):
    - agent_archetypes table with bilingual fields (EN + PT-BR)
    - Fields: archetype, name, description, systemPrompt, defaultTools, trigger, icon
  packages/db/src/seed/archetypes.ts (NEW):
    - 5 archetype seeds with full system prompts:
      1. Agente de Atendimento WhatsApp (support, always_on)
      2. Representante de Vendas/SDR (sales, scheduled)
      3. Redator de Conteudo (content_writer, manual)
      4. Monitor Financeiro (finance, scheduled)
      5. Analista de Dados (data_analyst, manual)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #16 — P1-6.2 + P1-6.4: Approval Rules System
================================================================================
Hash:     90f9715
Date:     2026-02-24
Tasks:    P1-6.2 (Approval resolution flow), P1-6.4 (Always allow/block rules)
================================================================================

WHAT WAS BUILT:
  packages/db/src/schema/approval-rules.ts (NEW):
    - approval_rules table: projectId, agentId, toolName (unique), action enum
    - Actions: always_allow, always_block, require_approval
  packages/api/src/routers/approvals.ts (REWRITTEN):
    - Added listAll (with status filter + pagination)
    - Added listRules, setRule (upsert), deleteRule
  packages/ai/src/engine/approval-check.ts (NEW):
    - checkApprovalRule(projectId, agentId, toolName) → ApprovalAction | null

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #17 — P1-7.1 + P1-7.2: Pix & NFe Finance Tools
================================================================================
Hash:     c23a16b
Date:     2026-02-24
Tasks:    P1-7.1 (Pix monitoring), P1-7.2 (NFe status check)
================================================================================

WHAT WAS BUILT:
  packages/ai/src/tools/finance/pix.ts (NEW):
    - monitor_pix_transactions: EFI Bank (Gerencianet) Pix API
    - Date range + status filter, Brazilian currency formatting
  packages/ai/src/tools/finance/nfe.ts (NEW):
    - check_nfe_status: SEFAZ API for NF-e validation
    - 44-digit access key parsing fallback when API not configured
  packages/ai/src/tools/finance/index.ts (NEW):
    - Barrel export for finance tools
  Total tools registered: 21

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #18 — P1-1.5, P1-4.5, P1-6.3: Templates, Teams, Notifications
================================================================================
Hash:     b7623a0
Date:     2026-02-24
Tasks:    P1-1.5 (WhatsApp templates), P1-4.5 (Agent teams), P1-6.3 (Notifications)
================================================================================

WHAT WAS BUILT:
  packages/db/src/seed/whatsapp-templates.ts (NEW):
    - 5 default PT-BR templates: welcome, follow_up, appointment_reminder,
      payment_confirmation, support_response
    - seedWhatsAppTemplates(projectId) function
  packages/db/src/schema/agents.ts (MODIFIED):
    - Added `team` field with agentTeamEnum
    - Index on team column
  packages/db/src/schema/enums.ts (MODIFIED):
    - Added agentTeamEnum: development, research, marketing, sales, support,
      finance, operations
  packages/api/src/routers/agents.ts (MODIFIED):
    - Added team field to create + update mutations
  packages/api/src/services/approval-notifications.ts (NEW):
    - notifyApprovalRequested() with Socket.IO, email, WhatsApp channels
    - Rate-limited: 1 per minute per user
    - PT-BR email template with DOS aesthetic styling

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================


================================================================================
COMMIT #19 — P1-4.1, P1-6.1, P1-3.3, P1-3.4: Agent List, Approvals, Memory UI
================================================================================
Hash:     a638975
Date:     2026-02-25
Tasks:    P1-4.1, P1-6.1, P1-3.3, P1-3.4
================================================================================

WHAT WAS BUILT:
  apps/web/src/app/[locale]/(auth)/agents/page.tsx (REWRITTEN):
    - Agent list page: card grid with status dots (animated pulse for working)
    - Archetype badges, team badges, tool count, relative timestamps
    - Loading skeletons, empty state with "Create Agent" CTA, error state
  apps/web/src/app/[locale]/(auth)/approvals/page.tsx (REWRITTEN):
    - Approval inbox: Pending/All tabs
    - Risk level badges (low=cyan, medium=warning, high=orange, critical=red)
    - Expandable JSON payload preview
    - Approve/Reject buttons with optional comment field
    - Real-time invalidation after mutations
  apps/web/src/app/[locale]/(auth)/memory/page.tsx (REWRITTEN):
    - Two tabs: Company Documents + Agent Memory
    - Semantic search bar with results display
    - Drag-and-drop file upload zone (PDF, DOCX, TXT, CSV)
    - Ingested document list with chunk counts + delete
    - Agent memory key-value editor with inline editing
  packages/api/src/routers/documents.ts (NEW):
    - list, search, upload, delete procedures for documents
  packages/api/src/routers/agent-memory.ts (NEW):
    - list, update, delete procedures for agent memory entries
  apps/web/messages/en-US.json + pt-BR.json (MODIFIED):
    - Added agents, approvals, memory translation namespaces

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #20 — P1-4.2, P1-4.3, P1-8.1, P1-8.2, P1-8.3: Wizard, Detail, Activity
================================================================================
Hash:     6dcb210
Date:     2026-02-25
Tasks:    P1-4.2, P1-4.3, P1-8.1, P1-8.2, P1-8.3
================================================================================

WHAT WAS BUILT:
  apps/web/src/app/[locale]/(auth)/agents/new/page.tsx (NEW):
    - 7-step agent creation wizard
    - Steps: Name+Archetype → System Prompt → Tools → Memory → Trigger → Team → Review
    - Archetype pre-fill for prompts and tools
    - Step indicator with numbered dots and connecting lines
    - Auto slug generation from name
  apps/web/src/app/[locale]/(auth)/agents/[id]/page.tsx (NEW):
    - Agent detail page with 4 tabs: Overview, Configuration, Activity Log, Memory
    - Editable config: system prompt (bilingual), tools, trigger, memory, team
    - "Test Run" button, Active/Inactive toggle
    - Inline memory editor with key-value editing
  apps/web/src/app/[locale]/(auth)/analytics/page.tsx (REWRITTEN):
    - Activity log list with filters (agent, status) and pagination
    - Action detail drawer (400px slide-in from right)
    - Session timeline view with vertical timeline nodes
    - Collapsible JSON payloads, duration, token costs
  apps/web/messages/en-US.json + pt-BR.json (MODIFIED):
    - Added agentWizard, agentDetail, activity translation namespaces

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
  EPIC P1-4 COMPLETE — All tasks done (P1-4.1–P1-4.5)
  EPIC P1-5 COMPLETE — All 5 archetypes seeded
  EPIC P1-6 COMPLETE — All tasks done (P1-6.1–P1-6.4)
  EPIC P1-7 COMPLETE — Both finance tools done
  EPIC P1-8 COMPLETE — All 3 activity log views done
================================================================================


================================================================================
COMMIT #21 — Audit Fixes
================================================================================
Hash:     a98027e
Date:     2026-02-25
Tasks:    N/A (repo-wide audit)
================================================================================

WHAT WAS FIXED:
  packages/api/src/routers/action-logs.ts:
    - Changed direct drizzle-orm imports to @ai-office/db
    - Added ! non-null assertions on ctx.project.id
  packages/api/src/trpc.ts:
    - Changed direct drizzle-orm imports to @ai-office/db
  packages/api/src/services/approval-notifications.ts:
    - Fixed projectId used where orgId needed — now queries project→org join
  apps/web/package.json:
    - Fixed workspace:^ → workspace:*
  apps/web/messages/en-US.json + pt-BR.json:
    - Added 13 missing approvals translation keys

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #22 — P1-3.7, P1-9.2, P1-9.4: Wiki, Onboarding, Feedback
================================================================================
Hash:     6213c92
Date:     2026-02-25
Tasks:    P1-3.7, P1-9.2, P1-9.4
================================================================================

WHAT WAS BUILT:
  packages/db/src/schema/wiki.ts (NEW):
    - wikiCategories: hierarchical (max 3 levels), self-ref FK with onDelete set null
    - wikiArticles: title, slug, summary, content, tags, authorId, attachedDocumentIds
  packages/db/src/schema/feedback.ts (NEW):
    - feedback: rating (1-5), category (bug/feature/confusion/praise), description
  packages/api/src/routers/wiki.ts (NEW):
    - 8 procedures: listCategories, createCategory, deleteCategory (reassigns children),
      listArticles, getArticle, createArticle, updateArticle, deleteArticle
    - ILIKE search with wildcard escaping
  packages/api/src/routers/feedback.ts (NEW):
    - submit, list (with category filter), stats (avg rating + by-category counts)
  apps/web/src/app/[locale]/(auth)/memory/page.tsx (MODIFIED):
    - Added Wiki tab with category tree sidebar, article detail view, new article/category forms
    - Fixed nested <button> HTML accessibility issue
    - Removed unused rootCategories variable
  apps/web/src/app/[locale]/(auth)/onboarding/page.tsx (NEW):
    - 6-step onboarding wizard: Welcome → Company → Template → Integration → Agent → Done
    - Framer Motion page transitions, typewriter effect, CSS confetti on completion
    - UI-only scaffold (no backend persistence yet — intentional for P1)
  apps/web/src/components/feedback-widget.tsx (NEW):
    - Floating feedback button (bottom-right), expandable form with star rating
    - Category selector, description textarea, submit with loading state
  apps/web/src/app/[locale]/(auth)/layout.tsx (MODIFIED):
    - Added FeedbackWidget to auth layout
  apps/web/messages/en-US.json + pt-BR.json (MODIFIED):
    - Added wiki, feedback, onboarding translation namespaces
    - Fixed all PT-BR diacritics (título, conteúdo, configuração, etc.)

REVIEW FIXES APPLIED:
  - wiki.ts schema: Added self-referencing FK on parentId with onDelete: 'set null'
  - wiki.ts router: Escape SQL wildcards (%, _) in ILIKE search
  - wiki.ts router: deleteCategory now reassigns children + unsets articles before delete
  - feedback.ts: Added ! assertion on submit return, fixed sql<string> for AVG()
  - memory/page.tsx: Fixed nested <button> → div+button siblings
  - memory/page.tsx: Removed unused rootCategories variable
  - pt-BR.json: Fixed 35+ missing diacritics across wiki/feedback/onboarding namespaces

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
  EPIC P1-3 COMPLETE — All tasks done (P1-3.1–P1-3.7) including Company Wiki
================================================================================


================================================================================
COMMIT #23 — P1-9.1, P1-9.3: Staging Config + Alpha Help Page
================================================================================
Hash:     918204f
Date:     2026-02-25
Tasks:    P1-9.1, P1-9.3
================================================================================

WHAT WAS BUILT:
  apps/web/.env.staging.example (NEW):
    - Full env template for Vercel staging: DB, Redis, Clerk, WhatsApp, LLM keys, observability
  apps/worker/.env.staging.example (NEW):
    - Worker env template for Railway: shared DB/Redis + BULLMQ_REDIS_URL, WORKER_CONCURRENCY
  packages/db/src/seed/staging-demo.ts (NEW):
    - Idempotent seed (onConflictDoUpdate) creating:
      - "Acme Demo Ltda" org (growth plan)
      - "Demo Admin" user (owner, pt-BR)
      - "Suporte & Vendas" project
      - 3 agents: Ana (support), Carlos (sales), Julia (content_writer)
      - 5 WhatsApp templates (welcome, follow_up, sales_outreach, appointment, support)
      - Wiki category "Políticas da Empresa" + full customer service policy article
  scripts/deploy-staging.sh (NEW):
    - Checks required env vars, builds, db:push, seeds, optional Vercel/Railway CLI deploy
  apps/web/src/app/[locale]/(auth)/help/page.tsx (NEW):
    - Alpha testing playbook with 8 accordion sections:
      Início Rápido, WhatsApp, Agentes, Aprovações, Monitoramento, Memória, Limitações, Bugs
    - Left sidebar navigation, scroll-to-section, expand/collapse all
    - Full PT-BR content via next-intl useTranslations('help')
  apps/web/messages/en-US.json + pt-BR.json (MODIFIED):
    - Added ~100 'help' namespace translation keys
    - Fixed all PT-BR diacritics in help namespace and staging seed

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
  *** PHASE 1 COMPLETE ***
  All 40 tasks across 9 epics done:
    P1-1: WhatsApp Business API (6 tasks)
    P1-2: External Tools — Email, Sheets, CRM, Search, OAuth2 (6 tasks)
    P1-3: Knowledge Base — Documents, RAG, Memory, Wiki (7 tasks)
    P1-4: Agent Configuration UI (5 tasks)
    P1-5: BR Agent Archetypes (5 tasks)
    P1-6: Approval System (4 tasks)
    P1-7: Finance Tools — Pix, NFe (2 tasks)
    P1-8: Activity Log UI (3 tasks)
    P1-9: Alpha Launch — Staging, Onboarding, Playbook, Feedback (4 tasks)
  Next: Phase 2 — Multi-Agent Collaboration & Workflow Engine
================================================================================


================================================================================
COMMIT #24 — Phase 1 Comprehensive Audit Fixes
================================================================================
Hash:     d19182a
Date:     2026-02-25
Tasks:    N/A (full codebase audit — 5 parallel agents, all packages)
================================================================================

WHAT WAS FIXED (18 fixes across 19 files):

  DB Schema:
    - agentMemory: added uniqueIndex on (agentId, projectId, key) — prevents upsert races
    - agentArchetypes: added uniqueIndex on (archetype) — prevents duplicate seeds
    - realtime events: added 'cancelled' to AgentActionEvent.status union

  API Routers (9 routers):
    - Added ! assertions on 14 .returning() results across projects, workflows,
      strategies, agents, whatsapp, email, approvals, agent-memory, users
    - tool-credentials: getScopes() now checks RDSTATION_SCOPES (was only GOOGLE)
    - agents: bounded tools array .max(50) + string .max(100)
    - approval-notifications: removed unused 'and' import

  Web App:
    - workflows/page.tsx: fixed non-existent translation key
    - analytics/page.tsx: nested button → div[role=button] in session timeline
    - agents/new/page.tsx: rounded-full → rounded-none (DOS aesthetic)
    - agents/[id]/page.tsx: removed unused useEffect import
    - analytics/page.tsx: removed unused ActionType type + tCommon variable

  Worker:
    - index.ts: SENTRY_DSN with NEXT_PUBLIC fallback

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #25 — Epic P2-1: Three.js Isometric Office — Scene Foundation
================================================================================
DATE: 2026-02-25
HASH: 1787a4f
PHASE: 2 — The Visualization
EPIC: P2-1 (7 tasks: P2-1.1 through P2-1.7)

WHAT WAS BUILT:
  Three.js isometric office scene using @react-three/fiber + drei.
  Dark DOS aesthetic with wireframe geometry, transparent fills, and cyan edge
  lighting. OrthographicCamera at [10,10,10] with constrained OrbitControls.
  4 rooms with 7 furniture types, grid floor, and floating PT-BR labels.

FILES CREATED (16 new):
  apps/web/src/components/office/OfficeCanvas.tsx — Main r3f Canvas, Suspense, next-intl
  apps/web/src/components/office/OfficeLighting.tsx — Ambient + directional + hemisphere
  apps/web/src/components/office/OfficeFloor.tsx — Floor slab with grid overlay
  apps/web/src/components/office/OfficeRooms.tsx — 4 rooms with wireframe walls + labels
  apps/web/src/components/office/OfficeLayout.tsx — Furniture placement from config
  apps/web/src/components/office/layouts/default.ts — Layout data (rooms, furniture positions)
  apps/web/src/components/office/index.ts — Barrel export
  apps/web/src/components/office/furniture/Desk.tsx — Wireframe desk
  apps/web/src/components/office/furniture/Monitor.tsx — Monitor with emissive screen
  apps/web/src/components/office/furniture/Chair.tsx — Wireframe chair
  apps/web/src/components/office/furniture/MeetingTable.tsx — Meeting table
  apps/web/src/components/office/furniture/ServerRack.tsx — Server rack with shelves
  apps/web/src/components/office/furniture/Couch.tsx — Wireframe couch
  apps/web/src/components/office/furniture/CoffeeMachine.tsx — Coffee machine
  apps/web/src/components/office/furniture/index.ts — Furniture barrel export
  apps/web/public/fonts/IBMPlexMono-Medium.ttf — IBM Plex Mono for 3D text labels

FILES MODIFIED (5):
  apps/web/package.json — Added three, @react-three/fiber, @react-three/drei,
    @react-three/postprocessing, @types/three, gsap
  apps/web/src/app/[locale]/(auth)/office/page.tsx — Renders <OfficeCanvas />
  apps/web/messages/en-US.json — office namespace (room labels, loading)
  apps/web/messages/pt-BR.json — office namespace with proper diacritics
  pnpm-lock.yaml — Updated lockfile

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  HIGH (4):
    1. Font file missing — /fonts/IBMPlexMono-Medium.ttf did not exist in public/
       → Downloaded from IBM Plex GitHub releases
    2. PT-BR diacritics missing — "Escritorio Aberto", "Sala de Reuniao",
       "CARREGANDO ESCRITORIO" → Fixed with proper accents (ó, ã, Ó)
    3. <Text> characters prop excluded diacritic glyphs → Expanded to include
       áàãâéêíóôõúçÁÀÃÂÉÊÍÓÔÕÚÇ
    4. No geometry.dispose() on unmount — GPU memory leak on 9 files → Added
       useEffect cleanup on all useMemo'd geometries

  MEDIUM (3):
    5. new THREE.Color() in JSX on every render → Hoisted to module constant
    6. wallHeight/wallThickness as local vars in useMemo deps → Moved to
       module-level constants (WALL_HEIGHT, WALL_THICKNESS, WALL_COLOR, EDGE_COLOR)
    7. Dead LoadingFallback component (rendered null) → Removed

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #26 — Epic P2-2: Agent Avatar System
================================================================================
DATE: 2026-02-25
HASH: 13322ee
PHASE: 2 — The Visualization
EPIC: P2-2 (5 tasks: P2-2.1 through P2-2.5)

WHAT WAS BUILT:
  Agent avatar 3D models as semi-transparent humanoid figures (capsule body +
  sphere head) rendered at desk positions with status-based emissive glow.
  5 status colors with pulsing animations, idle bob + breathing, floating
  name labels, position mapping system, and mock status cycling hook.

FILES CREATED (4 new):
  apps/web/src/components/office/AgentAvatar.tsx — Avatar component with glow/animations
  apps/web/src/components/office/AgentLayer.tsx — Renders all agent avatars
  apps/web/src/components/office/AgentPositions.ts — Desk slot position mapping
  apps/web/src/components/office/useAgentStatuses.ts — Status hook with mock cycling

FILES MODIFIED (4):
  apps/web/src/components/office/OfficeCanvas.tsx — Added AgentLayer + mock agents
  apps/web/src/components/office/index.ts — Exported new components + types
  apps/web/messages/en-US.json — Added status keys to office namespace
  apps/web/messages/pt-BR.json — Added matching PT-BR keys with diacritics

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  HIGH (3):
    1. useFrame stale closure — cfg + position captured in render scope, used inside
       useFrame callback → Added cfgRef + posRef updated every render
    2. Single debounce ref shared across all agents — one agent's update canceled
       another's → Changed to per-agent debounce Map
    3. agentIds referential instability could cause infinite effect teardown →
       Stabilized with idsKey = agentIds.join(',')

  MEDIUM (4):
    4. Label color #00D4FF deviated from brand accent → Changed to #00C8E0
    5. DoubleSide on closed convex geometry (sphere, cylinder) → Removed
    6. Materials not explicitly disposed on unmount → Added bodyMatRef/headMatRef
       disposal in useEffect cleanup
    7. Hardcoded MOCK_AGENTS with no TODO → Added replacement comment

  LOW (1):
    8. TEXT_CHARACTERS missing punctuation → Added .-_/()

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #27 — Epic P2-3: Click-to-Inspect Agent Detail
================================================================================
DATE: 2026-02-25
HASH: 3329555
PHASE: 2 — The Visualization
EPIC: P2-3 (3 tasks: P2-3.1 through P2-3.3)

WHAT WAS BUILT:
  Click-to-inspect system for agent avatars. Clicking an avatar opens a
  360px side panel with agent identity, status, live action feed, recent
  activity, and quick action buttons. Framer Motion slide animation.

FILES CREATED (1):
  apps/web/src/components/office/AgentInspectPanel.tsx — DOM overlay panel

FILES MODIFIED (6):
  AgentAvatar.tsx — Added click/hover handlers with ThreeEvent types, selection glow
  AgentLayer.tsx — Pass selectedAgentId + onSelectAgent through
  OfficeCanvas.tsx — Manage selected state, build inspected agent data, render panel
  index.ts — Export new components + types
  en-US.json — Added agentPanel namespace (12 keys)
  pt-BR.json — Added agentPanel namespace with PT-BR diacritics

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (1):
    1. THREE.Event deprecated type + casted stopPropagation → Changed to
       ThreeEvent<PointerEvent|MouseEvent> from @react-three/fiber

  MEDIUM (2):
    2. Redundant agent?.status in useEffect deps → Removed
    3. roomLabels recreated every render → Wrapped in useMemo

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #28 — Epic P2-4: Floor Layer System & Exploded View
================================================================================
DATE: 2026-02-25
HASH: 53cb777
PHASE: 2 — The Visualization
EPIC: P2-4 (3 tasks: P2-4.1 through P2-4.3)

WHAT WAS BUILT:
  Multi-floor office with 4 floors stacked vertically, smooth transitions,
  floor selector UI, and exploded view toggle. Zustand store for state.

FILES CREATED (9):
  layouts/types.ts — Shared types (FurniturePlacement, RoomLayout, FloorConfig)
  layouts/intelligence.ts — Floor 2 layout (Análise + Laboratório de Dados)
  layouts/communication.ts — Floor 3 layout (Marketing + Vendas)
  layouts/basement.ts — Basement layout (Datacenter with 15 server racks)
  layouts/floors.ts — FLOOR_CONFIGS master array + spacing constants
  FloorSystem.tsx — Multi-floor renderer with opacity lerp + material caching
  FloorCameraController.tsx — Smooth camera Y + zoom animation per floor
  FloorSelector.tsx — DOM overlay with floor buttons + exploded view toggle
  stores/floor-store.ts — Zustand store (activeFloor, exploded)

FILES MODIFIED (5):
  layouts/default.ts — Re-exports types from types.ts
  OfficeRooms.tsx — Optional layout prop (falls back to defaultLayout)
  OfficeLayout.tsx — Optional layout prop, removed = {} default
  AgentPositions.ts — Now indexes desks from ALL floor configs (not just default)
  OfficeCanvas.tsx — Uses FloorSystem instead of direct rendering

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (3):
    1. group.traverse() in useFrame every frame on all floors → Cached
       material references once on mount, iterate flat array in useFrame
    2. AgentPositions only indexed defaultLayout desks → Now iterates
       all FLOOR_CONFIGS for complete desk coverage
    3. useFloorStore in FloorLayer caused all floors to re-render →
       Subscribed via refs outside React render cycle

  MEDIUM (5):
    4. @ts-expect-error on OrbitControls type → Proper unknown cast
    5. Dead cameraTargetY state in Zustand store → Removed
    6. OfficeLayout = {} default param unreachable → Removed
    7. FloorSelector indexOf in map callback → Pre-computed with index
    8. baseY could diverge from formula if spacing changed → Use
       computed initialY from index formula

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #29 — Epic P2-5: Team Roster Panel
================================================================================
DATE: 2026-02-25
HASH: fa2f786
PHASE: 2 — The Visualization
EPIC: P2-5 (3 tasks: P2-5.1 through P2-5.3)

WHAT WAS BUILT:
  Team roster sidebar (DOM overlay, left side) showing all agents with
  status dots, names, and current actions. Three modes: expanded, collapsed
  (dots only), hidden. Zustand store with localStorage persistence.

FILES CREATED (2):
  apps/web/src/components/office/TeamRoster.tsx — Roster sidebar component
  apps/web/src/stores/roster-store.ts — Zustand store with persist

FILES MODIFIED (4):
  OfficeCanvas.tsx — Render TeamRoster, pass agents/statuses/actions
  index.ts — Export TeamRoster + types
  en-US.json — teamRoster namespace
  pt-BR.json — teamRoster namespace (fixed Unicode escapes → literal UTF-8)

REVIEW — ISSUES FOUND AND FIXED:
  MEDIUM (1):
    1. PT-BR translations used \u2014 and \u00e7\u00e3o Unicode escapes →
       Replaced with literal — and ção for consistency

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #30 — Epic P2-6: Data Flow Particle Animations
================================================================================
DATE: 2026-02-25
HASH: 21409a3
PHASE: 2 — The Visualization
EPIC: P2-6 (3 tasks: P2-6.1 through P2-6.3)

WHAT WAS BUILT:
  Particle animation system: data flow streams between agents and server
  room, plus ambient background particle field for atmosphere.

FILES CREATED (3):
  apps/web/src/components/office/DataFlow.tsx — 15-particle stream component
  apps/web/src/components/office/DataFlowLayer.tsx — Renders flows for active agents
  apps/web/src/components/office/AmbientParticles.tsx — 200 ambient particles

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (1):
    1. AmbientParticles drift was frame-rate dependent (0.005/frame, not
       multiplied by delta) → Changed to 0.3 units/sec * delta

  MEDIUM (1):
    2. Oscillation was additive per frame, accumulating X/Z drift over time
       → Changed to absolute offset from base position (no drift)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #31 — Epic P2-7: Visual Polish (Bloom, Header, Nav Controls)
================================================================================
DATE: 2026-02-25
HASH: 86dde9b
PHASE: 2 — The Visualization
EPIC: P2-7 (3 tasks: P2-7.1 through P2-7.3)

WHAT WAS BUILT:
  Post-processing bloom for emissive glow on avatars, monitors, particles.
  HeaderOverlay DOM panel (project title + active agent count).
  NavControls DOM panel (zoom +/-, pan d-pad, reset) dispatching camera
  actions through Zustand, consumed by FloorCameraController each frame.

FILES CREATED (2):
  apps/web/src/components/office/HeaderOverlay.tsx — DOM overlay top-left
  apps/web/src/components/office/NavControls.tsx — DOM overlay bottom-left

FILES MODIFIED (5):
  OfficeCanvas.tsx — Added EffectComposer+Bloom, HeaderOverlay, NavControls
  FloorCameraController.tsx — Extended with camera action consumption
  floor-store.ts — Added CameraAction type + dispatchCamera/clearCameraAction
  en-US.json / pt-BR.json — Added office.header and office.nav translations

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (2):
    1. FloorCameraController used Zustand selectors causing React re-renders
       in R3F scene graph → Refactored to ref-based subscription pattern
    2. Scene component not memo'd, causing full scene tree re-render on
       every parent state change → Wrapped in React.memo, extracted
       PostProcessing as separate memo'd component

  MEDIUM (1):
    3. camera.updateProjectionMatrix() called unconditionally every frame
       → Added threshold check (only update when zoom delta > 0.01)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #32 — Epic P2-8: Performance Optimization
================================================================================
DATE: 2026-02-25
HASH: cd03e0a
PHASE: 2 — The Visualization
EPIC: P2-8 (4 tasks: P2-8.1 through P2-8.4)

WHAT WAS BUILT:
  React.memo on all static R3F components (7 furniture, OfficeLighting,
  OfficeFloor, AgentAvatar with custom comparator). LOD system with
  zoom-based detail levels (SimpleFurniture boxes at far zoom).
  PerformanceMonitor with FPS hysteresis + lowPerformance Zustand flag.
  AmbientParticles responds to low-perf by reducing active particles.

FILES CREATED (3):
  apps/web/src/components/office/LODWrapper.tsx — useLODLevel + SimpleFurniture + LODWrapper
  apps/web/src/components/office/PerformanceMonitor.tsx — FPS sampling + DevStats
  apps/web/src/stores/perf-store.ts — lowPerformance + fps Zustand store

FILES MODIFIED (14):
  FloorSystem.tsx — Calls useLODLevel, passes lodLevel to OfficeLayout
  OfficeLayout.tsx — Accepts lodLevel, wraps furniture in LODWrapper
  AmbientParticles.tsx — Reads lowPerformance, hides inactive particles
  AgentAvatar.tsx — React.memo with custom comparator
  OfficeLighting.tsx — React.memo with displayName
  OfficeFloor.tsx — React.memo with displayName
  7x furniture/*.tsx — React.memo with displayName

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (1):
    1. AmbientParticles used Zustand selector causing React re-renders
       in R3F scene graph → Refactored to ref-based subscription pattern

  MEDIUM (4):
    2. FloorLayer not memo'd; all floors re-rendered on any prop change
       → Wrapped in React.memo with displayName
    3. OfficeLayout not memo'd → Wrapped in React.memo with displayName
    4. PerformanceMonitor setFps() fired every sample even when unchanged
       → Added equality check before updating store
    5. Frozen particles visible when lowPerformance kicks in
       → Inactive particles moved off-screen (Y = -100)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #33 — Epic P2-9: ATLAS Voice Interface (P2-9.1 through P2-9.5)
================================================================================
DATE: 2026-02-25
HASH: 0804842
PHASE: 2 — The Visualization
EPIC: P2-9 (5 of 9 tasks: P2-9.1 through P2-9.5; P2-9.6-P2-9.9 deferred to Phase 3)

WHAT WAS BUILT:
  ATLAS (Agent Tracking & Live Advisory System) voice interface. Canvas 2D
  animated orb with 4 visual states (idle/listening/thinking/speaking),
  each with distinct pulse speed, wave distortion, particle count, and
  color. Transcript panel with conversation history, suggestion buttons,
  and text input. Web Speech API STT and SpeechSynthesis TTS hooks.
  Zustand store for ATLAS state. Full PT-BR + EN-US translations.

FILES CREATED (7):
  apps/web/src/stores/atlas-store.ts — AtlasState + messages + intensity
  apps/web/src/components/atlas/OrbVisualization.tsx — Canvas 2D orb (memo'd)
  apps/web/src/components/atlas/TranscriptPanel.tsx — Conversation panel
  apps/web/src/components/atlas/index.ts — Barrel exports
  apps/web/src/hooks/use-speech-recognition.ts — Web Speech API STT hook
  apps/web/src/hooks/use-speech-synthesis.ts — SpeechSynthesis TTS hook
  apps/web/src/hooks/index.ts — Hooks barrel exports

FILES MODIFIED (3):
  apps/web/src/app/[locale]/(auth)/atlas/page.tsx — Full ATLAS page
  apps/web/messages/pt-BR.json — 23 atlas translation keys
  apps/web/messages/en-US.json — 23 atlas translation keys

REVIEW — ISSUES FOUND AND FIXED:
  HIGH (4):
    1. OrbVisualization effect re-ran on every intensity change (100ms) causing
       canvas teardown/setup stutter → Moved state+intensity into refs, effect
       runs once on mount only
    2. simulateResponse timer leak: rapid sends caused interleaved state
       transitions → Added clearTimeout at start of simulateResponse
    3. useSpeechRecognition isSupported caused hydration mismatch (server=false,
       client=true) → Deferred to useState+useEffect after mount
    4. useSpeechSynthesis same hydration mismatch → Same fix

  MEDIUM (4):
    5. Missing displayName on OrbVisualization memo → Added
    6. Mock response text missing PT-BR diacritics (relacao→relação, esta→está,
       critico→crítico, estavel→estável, etc.) → Fixed all
    7. Button title attributes hardcoded English → Using t('mute')/t('reset')
    8. Message ID collision risk with Date.now() → Added counter suffix

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

NOTE: P2-9.6 (context aggregation), P2-9.7 (conversational Q&A), P2-9.8
(command parsing), P2-9.9 (command execution) are deferred to Phase 3 as
they depend on backend systems (tRPC routers, agent execution, LLM wrapper).


================================================================================
COMMIT #34 — Phase 2 Comprehensive Audit Fixes
================================================================================
DATE: 2026-02-25
HASH: 0d669f8
PHASE: 2 — The Visualization (audit)

WHAT WAS FIXED:
  Full-phase audit covering all 9 epics (P2-1 through P2-9). Reviewed
  cross-cutting patterns, barrel exports, translation completeness,
  design consistency, memory leaks, and SSR safety.

  CRITICAL (1):
    1. OrbVisualization hardcoded 0.016 delta (assumed 60fps) — now uses
       requestAnimationFrame timestamp for real delta computation

  HIGH (1):
    2. AgentLayer called useAgentStatuses inside R3F Canvas, causing React
       re-renders in the scene graph — removed duplicate call, statuses now
       passed as props from OfficeCanvas through FloorSystem

  MEDIUM (2):
    3. 5 R3F scene-graph components missing React.memo + displayName
       (AgentLayer, DataFlow, DataFlowLayer, OfficeRooms) → Added
    4. AgentStatusMap type not exported from barrel → Added

  KNOWN ITEMS DEFERRED (not bugs, acceptable for Phase 2):
    - Hardcoded mock Portuguese strings in OfficeCanvas/AtlasPage (will be
      replaced by real data in Phase 3)
    - Inline JSX materials in furniture (R3F auto-disposes, acceptable)
    - useLODLevel useState in useFrame (infrequent LOD changes, acceptable)
    - Error messages in STT hook hardcoded English (will be replaced by
      translation keys when real STT integration lands)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

PHASE 2 STATUS: COMPLETE (9 epics, 34 commits, all pushed)


================================================================================
COMMIT #35 — Phase 2 Second-Pass Review Fixes
================================================================================
DATE: 2026-02-25
HASH: 2c664c3
PHASE: 2 — The Visualization (second-pass review)

WHAT WAS FIXED:
  Second comprehensive review of entire Phase 2 codebase. Found 1 critical,
  6 high, 9 medium, 3 low issues. Fixed the impactful ones:

  CRITICAL (1):
    1. Room component (inside OfficeRooms) was not wrapped in React.memo —
       caused R3F material recreation on parent re-renders → added React.memo

  HIGH (2):
    2. Atlas store messages array grew unboundedly — capped at 200
    3. AgentAvatar inline material JSX props referenced STATUS_CONFIG[status]
       which were immediately overwritten by useFrame every frame → changed
       to static COLOR_IDLE defaults (useFrame sets actual values per-frame)

  MEDIUM (2):
    4. OrbVisualization large delta on tab-resume caused animation teleport
       → clamped delta to max 0.1s
    5. SimpleFurniture size[0]/size[1]/size[2] in useMemo deps → properly
       destructured as [w, h, d]

  ITEMS REVIEWED BUT ACCEPTABLE:
    - useLODLevel setState in useFrame: only fires on LOD threshold crossings
      (rare), and the re-render IS the mechanism for swapping LOD content
    - useAgentStatuses Map reference: changes every 5s in demo mode, will be
      Zustand-based when real Socket.IO integration lands in Phase 3
    - Camera action single-value race: extremely unlikely (two clicks in one
      frame), not worth queue complexity for demo mode

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #36 — P1+P2 Comprehensive Security & Reliability Audit
================================================================================
DATE: 2026-02-25
HASH: 2eda868
PHASE: Cross-phase audit (P1 backend + P2 visualization)

WHAT WAS DONE:
  Ran 4 parallel audit agents across ALL project files: DB schemas, AI tools,
  tRPC routers, webhooks, shared utils, all R3F components, stores, and hooks.
  Total: 63 issues found (3 critical, 13 high, 29 medium, 18 low).
  Fixed 12 most impactful issues across 9 files.

SECURITY FIXES:
  1. CRITICAL: Vector custom type toDriver — validated numeric input to prevent
     SQL injection via crafted array values
  2. CRITICAL: Vector fromDriver — added runtime type guard (was casting
     unknown to string unsafely)
  3. HIGH: Webhook GET verify token — switched from === to timingSafeEqual
     to prevent timing attacks
  4. HIGH: Approval email template — HTML-escapes agentName and
     actionDescription to prevent XSS in email clients
  5. HIGH: CRM client double query-string — request() used string concat
     producing malformed URLs; switched to URL() constructor
  6. MEDIUM: SSRF attachment URL validator — expanded blocklist to include
     172.16.0.0/12, 0.0.0.0, ::1, fe80::, fd00:: private ranges

RELIABILITY FIXES:
  7. HIGH: email/send.ts DB audit insert — wrapped in try/catch (was
     unhandled, crashed the entire tool on DB failure)
  8. HIGH: whatsapp/send.ts same fix — wrapped DB insert in try/catch
  9. CRITICAL: useSocketEvent subscription leak — tracked subscribed socket
     in ref; polling now detects socket replacement and cleans up properly
  10. MEDIUM: Webhook queue.add() — wrapped in try/catch to prevent 5xx
     on Redis downtime (which causes provider retries + duplicate messages)
  11. MEDIUM: decryptCredentials — added minimum buffer length check and
     fixed Buffer concat for consistent UTF-8 decoding

PERFORMANCE:
  12. HIGH: OrbitControls target array — hoisted to module constant
     (inline array caused new reference every 5s, potential camera jitter)

REMAINING ITEMS (documented, deferred):
  - DB: Missing Drizzle relations() (needed for relational query API, Phase 3)
  - DB: toolCredentials plaintext columns (encryption enforcement, Phase 3)
  - DB: Missing indexes on workflowRuns.status, workflowNodeRuns.projectId
  - API: OAuth2 state parameter CSRF verification (Phase 3 OAuth epic)
  - API: TOCTOU race conditions in upsert patterns (5+ routers)
  - API: Wiki deleteCategory not in transaction
  - AI: Tool execute functions cast input without re-parsing (safe because
    executor validates via Zod before calling)
  - P2: Scene memo defeated by Map reference (acceptable for demo mode)

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

PHASE 2 + AUDITS STATUS: COMPLETE (commits #27-#36)


================================================================================
COMMIT #37 — Epic P3-3: Multi-Project Support
================================================================================
DATE: 2026-02-25
HASH: 5476505
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-3.1: Project Switcher Dropdown
    - New <ProjectSwitcher> component in sidebar with colored dots per project
    - Click to switch active project, updates Zustand project store
    - Integrated into existing sidebar layout

  P3-3.2: Settings Page Rebuild (5 Tabs)
    - Settings page rewritten with tabbed layout: General, Members, Billing,
      Notifications, Integrations
    - Each tab renders its own section with proper form controls
    - 532+ lines of settings UI (was minimal placeholder before)

  P3-3.3: Plan Tier Enforcement
    - New plan-limits.ts in @ai-office/shared with starter/growth/pro/enterprise
    - tRPC middleware extended with plan limit checks on create mutations
    - Agent, project, and workflow create routes enforce tier limits

  P3-3.4: Project Creation Wizard
    - 3-step wizard at /settings/projects/new (590 lines)
    - Plan limit check on step 1, upgrade banner if at capacity
    - i18n keys for projectWizard namespace in both locales

FILES: 12 changed, 1516 insertions, 15 deletions

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #38 — Epic P3-4: Ten Additional Agent Archetypes
================================================================================
DATE: 2026-02-25
HASH: 60b0b3c
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-4.1–P3-4.10: 10 New Agent Archetypes
    - email_campaign_manager: Email marketing automation
    - research: Deep research and analysis
    - recruiter: Talent sourcing and screening
    - social_media: Social media content management
    - mercado_livre: Mercado Livre marketplace integration
    - inventory_monitor: Stock level monitoring
    - legal_research: Legal document analysis (Brazil-focused)
    - ad_analyst: Advertising performance analysis
    - account_manager: Client relationship management
    - deployment_monitor: Infrastructure and deployment monitoring

  Supporting Changes:
    - DB enum extended with 10 new archetype values
    - API router validation updated for new archetypes
    - Agent wizard updated with icons, tool presets, and bilingual prompts
    - Agents list page updated with archetype labels
    - i18n: 30 new keys per locale (en-US + pt-BR)

FILES: 6 changed, 144 insertions, 1 deletion

VERIFICATION:
  - turbo typecheck --force: 8/8 pass


================================================================================
COMMIT #39 — Epic P3-1: Visual Workflow Editor (React Flow)
================================================================================
DATE: 2026-02-25
HASH: 83f68d6
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-1.1: React Flow Canvas
    - @xyflow/react integrated with dark theme matching DOS aesthetic
    - Minimap, controls toolbar, snap-to-grid (20px)
    - Background dot pattern, fitView on load

  P3-1.2: 6 Custom Node Types
    - TriggerNode: Workflow entry point (webhook, schedule, manual)
    - AgentNode: AI agent execution step
    - ConditionNode: If/else branching with expression field
    - ApprovalNode: Human approval gate
    - DelayNode: Time delay with duration display
    - OutputNode: Workflow output/result endpoint
    - All nodes styled with DOS aesthetic (cyan borders, monospace)

  P3-1.3: Configuration Panel
    - Right-side panel (297 lines) with per-node-type forms
    - Dynamic form fields based on selected node type
    - Agent selection, condition expressions, delay configuration

  P3-1.4: Workflow Save/Load
    - Editor page at /workflows/[id] with tRPC save/load
    - Serializes React Flow nodes + edges to DB JSON columns

  P3-1.6: Workflow List Page
    - Card grid layout with workflow name, status, node count
    - Skeleton loading states, empty state, error state
    - Create new workflow button → navigates to editor

  NOT YET DONE (deferred to later):
    - P3-1.5: Parallel branch support (DAG executor dependency)
    - P3-1.7: DAG executor (requires agent execution engine integration)
    - P3-1.8: Workflow run history

FILES: 15 changed, 1360 insertions, 4 deletions

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

PHASE 3 STATUS: IN PROGRESS (3/9 epics done — P3-1, P3-3, P3-4)


================================================================================
COMMIT #40 — Epic P3-2: Strategy Command Center
================================================================================
DATE: 2026-02-25
HASH: 829b22c
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-2.1: KPI Dashboard Bar
    - 6-metric horizontal grid (MRR, Leads, Churn, NPS, Actions, Strategies)
    - Trend indicators (up/down/flat) with color-coded direction
    - Churn metric correctly inverts color (down = good)
    - Mock data with TODO for real tRPC data source (Phase 4)
    - i18n: all labels use translation keys

  P3-2.2: Gantt-Style Timeline View
    - 12-column CSS grid representing Jan-Dec
    - Strategy bars positioned by startDate/endDate with status-based colors
    - Active=#27AE60, At Risk=#F39C12, Planned=#484F58, Completed=#00C8E0
    - Vertical dashed "TODAY" line at current month
    - Click-to-select opens strategy detail panel
    - Cross-year edge case guard (skips bars where endMonth < startMonth)

  P3-2.3: Agent Learning Insight Strip
    - Fetches pending learnings via trpc.strategies.listPendingLearnings
    - Carousel navigation (prev/next) with counter
    - Apply/Dismiss buttons wired to real tRPC mutations
    - Confidence percentage badge
    - Auto-refetches every 60 seconds
    - Empty state with i18n message

  P3-2.4: Strategy Detail Panel
    - Framer Motion slide-in from right (400px wide)
    - 4 sections: Header (status + type badges), Definition (draft + AI refined),
      KPIs (progress bars with color coding), Learnings (with apply/dismiss)
    - ESC to close, click overlay to close
    - Loading skeleton while fetching
    - Apply/Dismiss buttons wired with cache invalidation

  P3-2.5: Strategy Creation Wizard
    - 2-step modal: Define (objective, type, dates) → Review (side-by-side)
    - 4 strategy type cards (Growth, Retention, Brand, Product)
    - Simulated AI refinement with 2.5s loading state
    - Creates strategy via tRPC with startDate/endDate
    - Timer cleanup on close (no memory leak)
    - Full i18n: all labels, placeholders, button text

  P3-2.6: Learning Application Flow
    - applyLearning: marks as applied + increments strategy version in transaction
    - dismissLearning: marks as applied (sets isApplied=true to remove from pending)
    - TODO: P3-2.6 merge learning into aiRefined text via Claude call

  P3-2.7: Goals Section (3 Time Horizons)
    - 3-column grid: 1-Year (blue), 6-Month (cyan), 1-Month (green)
    - Each goal card: icon, label, title, description, KPI progress bars
    - Color-coded progress (>=70% green, >=40% orange, <40% red)
    - Division-by-zero guard on progress calculation
    - Mock data with TODO for real goals endpoint

  P3-2.8: Learning Detection BullMQ Job
    - Analytics worker handles 'learning_detection' type
    - Queries active strategies + recent agent actions (7 days)
    - Finds most active agent per strategy
    - Deduplication: skips if learning exists for strategy+agent in past 7 days
    - Structured error logging (no silent catch)
    - TODO: Replace stub with real Claude analysis call

  tRPC Router Additions (3 new procedures):
    - listPendingLearnings: returns non-applied learnings for project
    - applyLearning: transactional apply + version increment
    - dismissLearning: marks as applied (removed from pending)
    - create: now accepts optional startDate/endDate

  i18n Expansion:
    - 60+ new keys per locale in strategy namespace
    - Covers: KPI labels, status/type names, wizard steps, insights,
      detail panel, goals, buttons, aria labels

  Review Fixes (from code review):
    1. CRITICAL: setTimeout memory leak in wizard — added ref + cleanup on close
    2. HIGH: 8 hardcoded English strings replaced with t() calls
    3. HIGH: Timeline cross-year guard (endMonth < startMonth → skip)
    4. HIGH: applyLearning wrapped in DB transaction (was 2 separate updates)
    5. MEDIUM: Goals division-by-zero guard on KPI progress
    6. MEDIUM: Analytics worker deduplication + error logging (was silent catch)

FILES: 12 changed, 1915 insertions, 17 deletions

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

================================================================================
COMMIT #41 — Epic P3-5: Company Templates & Onboarding
================================================================================
DATE: 2026-02-25
HASH: 2bb9a6b
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-5.1: Company Templates DB Table
    - company_templates Drizzle table with slug (unique), name_en, name_pt_br,
      description_en, description_pt_br, sector, market_focus (pgEnum),
      default_agents (jsonb), default_workflows (jsonb), icon, sort_order
    - marketFocusEnum added to enums.ts: 'br', 'global', 'both'
    - MarketFocus type added to shared types

  P3-5.2 + P3-5.3: Template Definitions (7 templates)
    - 3 Brazil-focused: Agência de Marketing (5 agents), E-Commerce BR (4 agents),
      Escritório de Advocacia (4 agents)
    - 3 Global: Marketing Agency (5 agents), Software Startup (4 agents),
      E-Commerce Global (4 agents)
    - 1 Universal: Blank Canvas (0 agents)
    - Each template has: bilingual names/descriptions, sector, market_focus,
      icon, agent specs (archetype, tools), workflow specs (trigger, steps)
    - getTemplatesForLocale() filters by market focus based on locale
    - getTemplateBySlug() lookup helper

  P3-5.4a: companyTemplates tRPC Router
    - list: returns all templates from shared constants
    - listForLocale: filters templates by pt-BR/en-US
    - getBySlug: lookup with input validation (.min(1).max(100))
    - provision: creates agents in project from template spec
      - enforceResourceLimit for plan agent quota
      - onConflictDoNothing for idempotent provisioning (no duplicate slug errors)
      - TRPCError NOT_FOUND for invalid slugs
    - Registered in root router as companyTemplates

  P3-5.4b: Onboarding Template Selector
    - Rewrote Step 2 from 2-option (blank/demo) to full template grid
    - Templates filtered by locale (BR templates for pt-BR, Global for en-US)
    - Each card: icon, bilingual name, description, agent count badge
    - Safe locale fallback (unknown locales default to en-US)

  P3-5.4c: New Project Wizard Template Step
    - Added Step 2 (Template) to wizard: Name → Template → Details → Review
    - Same template grid UI as onboarding
    - After project creation, provisions template agents via tRPC mutation
    - Fix: set active project BEFORE provision call (correct x-project-id header)

  AgentArchetype Type Fix
    - Updated shared AgentArchetype type from 10 to 21 values
    - Now matches all DB enum values (social_media, email_campaign_manager, etc.)

  i18n Keys (both locales):
    - Onboarding: replaced templateBlank/templateDemo with templateAgentCount,
      templateNoAgents, templateSector
    - Project Wizard: added stepTemplate, templateTitle, templateDescription,
      templateAgentCount, templateNoAgents

  Review Fixes (7 findings):
    1. CRITICAL: Provision was calling wrong project — reordered setCurrentProject
    2. HIGH: AgentArchetype missing 11 archetypes — added all 21
    3. HIGH: Unique constraint violation on slug — added onConflictDoNothing
    4. MEDIUM: Slug inputs lacked validation — added .min(1).max(100)
    5. MEDIUM: Invalid template slug returned silent success — throws NOT_FOUND
    6. MEDIUM: Provision ignored plan limits — added enforceResourceLimit
    7. MEDIUM: Unsafe locale cast — added explicit fallback to en-US

FILES: 12 changed, 565 insertions, 51 deletions
  NEW: packages/db/src/schema/company-templates.ts
  NEW: packages/shared/src/constants/company-templates.ts
  NEW: packages/api/src/routers/company-templates.ts

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

================================================================================
COMMIT #42 — Epic P3-7: Pix & Boleto Subscription Payments
================================================================================
DATE: 2026-02-25
HASH: dc08565
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-7.1: Stripe Integration Backend
    - billing DB tables: subscriptions + invoices with 3 new enums
    - stripeCustomerId column on organizations
    - Stripe webhook handler with timing-safe HMAC-SHA256 verification
    - 5 event handlers: checkout, invoice.paid, payment_failed,
      subscription.updated, subscription.deleted
    - Safe Stripe status mapping, price-to-plan mapping via env vars

  P3-7.1b: Billing tRPC Router (5 procedures)
    - currentSubscription, invoiceHistory, planPricing
    - createCheckoutSession, createPortalSession (admin-only stubs)

  P3-7.2: Pix Provider Stub (EFI Bank interface)
  P3-7.3: Boleto Provider Stub (annual plans only)

  P3-7.4: Billing Management Page
    - Plan comparison grid (4 tiers, monthly/annual toggle, BRL/USD)
    - Usage meters, subscription status, invoice history table
    - Payment method badges (Pix + Boleto for pt-BR)
    - 20+ new i18n keys per locale

  Review Fixes:
    1. CRITICAL: Timing-safe HMAC comparison (timingSafeEqual)
    2. CRITICAL: Stripe status mapping (handles incomplete/paused)
    3. HIGH: Empty-string env var key collision → filtered
    4. HIGH: onConflictDoUpdate for idempotent webhooks
    5. HIGH: Admin role required for billing mutations
    6. MEDIUM: HTTPS-only URL validation for invoices
    7. MEDIUM: PlanTier type for pricing/feature records

FILES: 15 changed, 1002 insertions, 14 deletions

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

PHASE 3 STATUS: IN PROGRESS (6/9 done — P3-1..P3-5, P3-7; P3-6 & P3-8 deferred)


================================================================================
COMMIT #43 — Epic P3-9: DevOps Board & Human Tasks
================================================================================
DATE: 2026-02-25
HASH: 7d794ee
PHASE: 3 — Workflow Builder & Brazil Launch

WHAT WAS BUILT:
  P3-9.4: DevOps Data Model
    - devops_requests table: uuid PK, projectId, agentId, type enum
      (deploy/pr_review/rollback/infra_change), priority, status (6 states),
      metadata jsonb (branch, commitSha, prUrl, environment), review fields
    - human_tasks table: uuid PK, projectId, agentId, assignedTo,
      status (todo/in_progress/done), priority (low/medium/high/urgent),
      context, devopsRequestId FK, dueAt, completedAt
    - 5 new pgEnums: devops_request_type, devops_request_status,
      devops_priority, human_task_status, human_task_priority
    - Proper indexes on projectId, agentId, status, type

  P3-9.5: tRPC Router (12 procedures)
    - listRequests, getRequest, createRequest, reviewRequest,
      markDeployed, markFailed (devops requests)
    - listTasks, createTask, updateTaskStatus, assignTask, deleteTask
      (human tasks)
    - Status guards: reviewRequest only for pending/in_review,
      markFailed only for approved/deployed
    - FK validation: agentId checked against project, assignedTo
      checked against org

  P3-9.1-3: DevOps Board UI (Kanban + Human Tasks)
    - Two-tab layout: Board (Kanban) + Human Tasks
    - Kanban: 3 columns (Pending / In Review / Deployed) with count badges
    - DevOps cards: type icon, priority badge, branch info, approve/reject
      buttons, mark deployed action
    - Human Tasks: 3 columns (To Do / In Progress / Done) with status
      transition buttons
    - Task cards: agent attribution, priority badges, due dates,
      expandable descriptions
    - Loading skeletons, empty states, error feedback
    - Dark DOS aesthetic throughout

  P3-9.6: Agent Tools (3 tools)
    - create_deploy_request: deploy/rollback/infra_change with metadata
    - create_pr_review_request: PR URL, branch, priority
    - create_human_task: title, description, context, priority
    - All tools registered in tool registry
    - requiresApproval: true for deploy requests

  Review Fixes (7 of 15 findings fixed):
    1. HIGH: reviewRequest lacked status guard — added pending/in_review check
    2. MEDIUM: markFailed lacked status guard — added approved/deployed check
    3. MEDIUM: createRequest agentId cross-project injection — added FK validation
    4. MEDIUM: createTask FK validation for agentId, assignedTo, devopsRequestId
    5. MEDIUM: assignTask no org check on assignedTo — added org validation
    6. MEDIUM: relativeTime NaN/future date handling — added guards
    7. LOW: approve/reject buttons only for pending — extended to in_review
    8. LOW: variable shadow `t` in filter → renamed to `task`

FILES: 14 changed, 1496 insertions, 2 deletions

VERIFICATION:
  - turbo typecheck --force: 8/8 pass

PHASE 3 STATUS: COMPLETE (7/9 done — P3-1..P3-5, P3-7, P3-9; P3-6 & P3-8 deferred)
  Ready for deployment and testing.


================================================================================
COMMIT #44 — Office Page Overhaul: Single Floor + Real Data + Panel Repositioning
================================================================================
DATE: 2026-02-26
HASH: 1e34194
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS BUILT:
  Single-Floor Unified Layout
    - New layouts/unified.ts: all 9 rooms from 4 floors merged onto one Y=0
      plane across 4 tiled rows:
        Row 1 (Z=0):  Open Workspace, Meeting Pod, Breakroom, Server Rack
        Row 2 (Z=10): Analysis Room, Data Lab
        Row 3 (Z=18): Marketing, Sales
        Row 4 (Z=25): Datacenter
    - floors.ts reduced from 4 FloorConfigs to 1 unified entry
    - OfficeFloor.tsx floor slab enlarged from 20×15 to 22×36 units

  FloorSystem Simplification
    - Removed multi-floor iteration, opacity lerping, Y-position animation,
      material traversal, ghost/active logic (~150 lines removed)
    - Single <group> at Y=0 with unified layout
    - Agents now passed as props instead of hardcoded FLOOR_AGENTS

  Floor Store & Camera
    - floor-store.ts: removed activeFloor, exploded, setActiveFloor,
      toggleExploded, setExploded; kept only camera actions
    - FloorCameraController.tsx: removed floor-based Y computation and
      zoom lerping; static target at [10, 0, 16] with zoom 35
    - FloorSelector.tsx: deleted entirely (no longer needed)

  Real Agent Data via tRPC
    - OfficeCanvas.tsx: replaced ALL_MOCK_AGENTS + AGENT_ROOM_MAP +
      useAgentStatuses mock cycling with trpc.agents.list.useQuery()
    - Team-to-room mapping: support/operations/finance → openWorkspace,
      sales → sales, marketing → marketing, development → dataLab,
      research → analysisRoom
    - Agent statuses read directly from DB (agent.status field)
    - Slot indices computed per-room from agent order within each team

  TeamRoster Panel Repositioned
    - Moved from left side to right side (toggle button, expanded panel,
      collapsed dots)
    - Animation direction: slide-from-left → slide-from-right
    - Border: borderRight → borderLeft

  DataFlowLayer Update
    - Server room target moved from [6, -3, 4] (basement) to [6, 0, 29]
      (datacenter on unified floor)

FILES: 11 changed, 352 insertions, 482 deletions
  - NEW: layouts/unified.ts
  - DELETED: FloorSelector.tsx
  - MODIFIED: FloorSystem.tsx, OfficeCanvas.tsx, FloorCameraController.tsx,
    OfficeFloor.tsx, TeamRoster.tsx, DataFlowLayer.tsx, index.ts,
    layouts/floors.ts, floor-store.ts

VERIFICATION:
  - tsc --noEmit: 0 errors
  - next build: compiled successfully


================================================================================
COMMIT #45 — Office Camera & Visibility Fixes
================================================================================
DATE: 2026-02-26
HASH: e63c543
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS FIXED:
  1. Isometric Camera Angle
    - Camera position [10,10,10] → [25,15,31] for proper diagonal isometric view
      instead of near-top-down
    - FloorCameraController reset offset updated to [15,15,15] to match

  2. Near-Plane Clipping
    - OrthographicCamera near plane 0.1 → -200 to prevent objects disappearing
      when close to the camera (orthographic cameras support negative near planes)

  3. Offline Agent Visibility
    - AgentAvatar offline baseIntensity 0.1 → 0.4 (was nearly invisible)
    - Offline color #444444 → #666666 (brighter grey on dark background)

FILES: 3 changed, 6 insertions, 6 deletions
  - MODIFIED: OfficeCanvas.tsx, FloorCameraController.tsx, AgentAvatar.tsx

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #46 — Fix: /workflows/new "Workflow not found"
================================================================================
DATE: 2026-02-26
HASH: 85c075e
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS FIXED:
  - Clicking "New Workflow" navigated to /workflows/new but no new/page.tsx
    existed — Next.js caught it with [id]/page.tsx using id="new", which
    failed UUID validation on getById and showed "Workflow not found"
  - Created dedicated /workflows/new/page.tsx that:
    1. Auto-creates an "Untitled Workflow" via workflows.create mutation
    2. Redirects to /workflows/{newId} to open the editor
    3. Shows error state with back-link if creation fails
  - Added i18n keys: creating, createError, backToWorkflows (en-US + pt-BR)

FILES: 3 changed, 57 insertions, 2 deletions
  - NEW: apps/web/src/app/[locale]/(auth)/workflows/new/page.tsx
  - MODIFIED: messages/en-US.json, messages/pt-BR.json

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #47 — Remove "Coming Soon" Badges from Sidebar
================================================================================
DATE: 2026-02-26
HASH: 16ee43b
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS FIXED:
  - Removed comingSoon: true flags from 5 sidebar nav items that still had
    "Em Breve" / "Coming Soon" badges despite features being implemented:
    Atlas, Workflows, DevOps, Strategy, Analytics
  - All nav items now link directly without qualifier badges

FILES: 1 changed, 5 insertions, 5 deletions
  - MODIFIED: components/layout/sidebar.tsx


================================================================================
COMMIT #48 — Tools Catalog Page
================================================================================
DATE: 2026-02-26
HASH: f944d3a
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS BUILT:
  - Replaced stub tools page (just showed "Ferramentas" centered) with full
    tool catalog displaying all 22 agent tools across 8 categories:
      Built-in (3): get_current_time, search_company_memory, log_message
      WhatsApp (2): send/read messages
      Email (2): send/read emails
      Web Search (1): search_web (Serper API)
      CRM (5): contacts + deals (RD Station)
      Google Sheets (3): read/write/append
      Finance (2): Pix monitoring, NFe status
      DevOps (3): deploy requests, PR reviews, human tasks
  - Each tool card shows: name, description, approval badge (if required),
    OAuth2 connection status (connected/not connected for Google/RD Station)
  - Fetches real credential status via trpc.toolCredentials.list
  - Added toolsPage i18n namespace (en-US + pt-BR)

FILES: 3 changed, 239 insertions, 5 deletions
  - MODIFIED: apps/web/src/app/[locale]/(auth)/tools/page.tsx,
    messages/en-US.json, messages/pt-BR.json

VERIFICATION:
  - tsc --noEmit: 0 errors


================================================================================
COMMIT #49 — Remove Project Switcher from Sidebar
================================================================================
DATE: 2026-02-26
HASH: 003aee3
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT WAS FIXED:
  - Removed ProjectSwitcher component and its wrapping div from sidebar
  - Removed unused import of ProjectSwitcher

FILES: 1 changed, 4 deletions
  - MODIFIED: components/layout/sidebar.tsx

================================================================================

================================================================================
COMMIT #53 — Add Missing Delete/Edit/Link Buttons Across CRUD Pages
================================================================================
DATE: 2026-02-26
HASH: def9299
PHASE: Post-Phase 3 — Polish & Deployment Prep

WHAT CHANGED:
  - Agent list: cards now wrapped in <Link> to detail page (same pattern as workflows)
  - Agent detail: added delete button (danger variant) with inline confirm pattern
  - Workflows list: added trash icon on cards with inline confirm, stopPropagation on Link
  - Workflow editor: added Delete (danger) + Run/Trigger (secondary) buttons in header
  - Strategy detail panel: added Edit button toggling userDraft textarea + status dropdown
  - i18n: added missing keys in agentDetail, workflows, strategy namespaces (en-US + pt-BR)

FILES: 7 changed, +267 -36
  - MODIFIED: apps/web/messages/en-US.json
  - MODIFIED: apps/web/messages/pt-BR.json
  - MODIFIED: apps/web/src/app/[locale]/(auth)/agents/page.tsx
  - MODIFIED: apps/web/src/app/[locale]/(auth)/agents/[id]/page.tsx
  - MODIFIED: apps/web/src/app/[locale]/(auth)/workflows/page.tsx
  - MODIFIED: apps/web/src/app/[locale]/(auth)/workflows/[id]/page.tsx
  - MODIFIED: apps/web/src/components/strategy/strategy-detail.tsx

VERIFICATION:
  - tsc --noEmit: 0 errors

================================================================================

================================================================================
COMMIT #54 — Wire Agent Trigger to BullMQ Execution Queue
================================================================================
DATE: 2026-02-26
HASH: bdb9feb
PHASE: Post-Phase 3 — Agent Execution Wiring

WHAT CHANGED:
  - agents.trigger tRPC endpoint now enqueues a real BullMQ job via getAgentExecutionQueue()
  - Generates unique sessionId per trigger, passes agentId + projectId + triggerPayload
  - Added @ai-office/queue as dependency of @ai-office/api package
  - Removed TODO comment — trigger is now fully wired to worker

FILES: 3 changed, +23 -7
  - MODIFIED: packages/api/src/routers/agents.ts
  - MODIFIED: packages/api/package.json
  - MODIFIED: pnpm-lock.yaml

VERIFICATION:
  - tsc --noEmit: 0 errors

================================================================================
