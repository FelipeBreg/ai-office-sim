================================================================================
  AI OFFICE SIM — DEVELOPMENT LOG
  Repository: https://github.com/FelipeBreg/ai-office-sim
  Roadmap: ProjectA_Development_Roadmap.html (246 tasks, 50 epics, 6 phases)
  Generated by: Claude Opus 4.6 (AI pair programmer)
================================================================================


================================================================================
COMMIT #1 — Epic P0-1: Monorepo & Project Scaffolding
================================================================================
Hash:     9f3beec55be0c08b2c4c675cfa63a34c42a30f0b
Date:     2026-02-24 17:46:38 -0300
Tasks:    P0-1.1 through P0-1.7 (7 tasks)
================================================================================

WHAT WAS BUILT:
  - Root monorepo with Turborepo + pnpm workspaces
  - turbo.json with pipelines: build, dev, lint, typecheck, test, clean
  - apps/web: Next.js 15, App Router, Tailwind CSS v4, Turbopack
    - Directory structure for all 11 screens under [locale]/(auth)/
    - globals.css with 24 design system CSS tokens
    - IBM Plex Mono font via next/font/google
    - PostCSS config for Tailwind v4
  - apps/worker: Node.js TypeScript service
    - HTTP health endpoint on port 4000
    - Graceful SIGTERM shutdown
    - tsx for dev hot-reload
  - packages/db: Drizzle ORM (schema, migrations, client, seed scripts)
  - packages/api: tRPC with superjson transformer, publicProcedure, root router
  - packages/shared: TypeScript types, Zod schemas, constants, utilities
  - packages/ai: Agent engine package (stub, populated in P0-6/P0-7)
  - packages/queue: BullMQ queue definitions (stub, populated in P0-3)
  - packages/realtime: Socket.IO event types (stub, populated in P0-9)
  - packages/tsconfig: Shared configs (base, nextjs, node, library)
  - packages/eslint-config: Shared ESLint configs (base, next, node)
  - docker-compose.yml: PostgreSQL 16 (pgvector image) + Redis 7-alpine
  - .env.example with all 11 required environment variables
  - Prettier config (.prettierrc + .prettierignore)
  - .gitignore, .npmrc

FILES CREATED (64 files):
  Root:
    .env.example, .gitignore, .npmrc, .prettierignore, .prettierrc,
    docker-compose.yml, package.json, pnpm-lock.yaml, pnpm-workspace.yaml,
    turbo.json
  apps/web:
    .eslintrc.cjs, next.config.mjs, package.json, postcss.config.mjs,
    tsconfig.json, src/app/globals.css, src/app/layout.tsx, src/app/page.tsx
  apps/worker:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/db:
    .eslintrc.cjs, drizzle.config.ts, package.json, tsconfig.json,
    src/client.ts, src/index.ts, src/schema/index.ts
  packages/api:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts, src/root.ts,
    src/trpc.ts
  packages/shared:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts,
    src/types/index.ts, src/constants/index.ts, src/schemas/index.ts,
    src/utils/index.ts
  packages/ai:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/queue:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/realtime:
    .eslintrc.cjs, package.json, tsconfig.json, src/index.ts
  packages/tsconfig:
    package.json, base.json, library.json, nextjs.json, node.json
  packages/eslint-config:
    package.json, base.js, next.js, node.js

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. .eslintrc.js used CJS syntax (module.exports) in ESM packages ("type":"module")
       → Renamed all 7 files to .eslintrc.cjs
    2. Font-family in globals.css used literal 'IBM Plex Mono' instead of CSS var
       → Changed to var(--font-family-mono) referencing var(--font-mono) from next/font
    3. Missing --font-family-mono in @theme block, so Tailwind font-mono utility broken
       → Added --font-family-mono to @theme

  MEDIUM (6):
    4. next.config.js and postcss.config.js used ESM export without "type":"module"
       → Renamed both to .mjs
    5. --spacing-* tokens in wrong Tailwind v4 namespace
       → Moved to --width-* and --height-* namespaces
    6. Duplicate bullmq + ioredis in both worker and queue packages
       → Removed from worker, consumed through @ai-office/queue only
    7. 26 CSS tokens instead of spec's 24 (duplicate risk/status colors)
       → Removed 3 duplicate risk tokens, kept only --color-risk-critical
    8. Hardcoded lang="pt-BR" in layout (will be dynamic with i18n)
       → Noted for P0-8 fix
    9. Non-null assertion (!) on DATABASE_URL in drizzle.config.ts
       → Added runtime check with clear error message

  MINOR (3):
    10. Missing explicit outputs:[] in turbo lint/typecheck/test tasks → Added
    11. Missing eslint-config-next peer dependency → Added as optional
    12. Aggressive * { border-radius: 0 !important } → Replaced with --radius-* tokens

VERIFICATION:
  - pnpm install: zero errors across 11 workspaces
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Design system: 24 CSS tokens confirmed


================================================================================
COMMIT #2 — Epic P0-2: PostgreSQL & Drizzle ORM Setup
================================================================================
Hash:     12b302d05673b6c166451fc94e6c819216b31b8a
Date:     2026-02-24 17:56:18 -0300
Tasks:    P0-2.1 through P0-2.9 (9 tasks; P0-2.10 Supabase RLS deferred to staging)
================================================================================

WHAT WAS BUILT:
  15 database tables across 10 schema files:
    - organizations: uuid PK, name, slug (unique), clerk_org_id, plan enum
    - users: uuid PK, clerk_user_id (unique), email, name, locale, role enum, org FK
    - projects: uuid PK, org FK, name, slug, color, composite unique (org_id, slug)
    - agents: uuid PK, project FK, name, archetype/status/trigger enums, config jsonb,
              tools text[], system prompts (EN+PT-BR), unique (project_id, slug)
    - agent_memory: uuid PK, agent FK, project FK, key/value, embedding vector(1536)
    - action_logs: uuid PK, project FK, agent FK, session_id, action_type, tokens,
                   cost, duration, composite index (project_id, created_at)
    - approvals: uuid PK, project FK, agent FK, action_log FK, risk_level enum,
                 status enum, reviewed_by FK (nullable)
    - workflows: uuid PK, project FK, name, definition jsonb (React Flow graph)
    - workflow_runs: uuid PK, workflow FK, project FK, status enum
    - workflow_node_runs: uuid PK, run FK, project FK, node_id, agent FK
    - documents: uuid PK, project FK, title, source_type enum, content
    - document_chunks: uuid PK, document FK, project FK, embedding vector(1536)
    - strategies: uuid PK, project FK, type enum, user_draft, ai_refined, status enum
    - strategy_kpis: uuid PK, strategy FK, project FK, current/target values
    - strategy_learnings: uuid PK, strategy FK, project FK, agent FK, insight

  Supporting files:
    - custom-types.ts: pgvector vector(1536) custom Drizzle type
    - enums.ts: 16 PostgreSQL enums (plan, user_role, locale, agent_archetype,
                agent_status, trigger_type, memory_scope, action_status, risk_level,
                approval_status, workflow_run_status, document_source_type,
                strategy_type, strategy_status, kpi_direction)
    - seed.ts: Idempotent seed script creating 1 org, 1 user, 1 project,
               3 agents (Support/Sales/Data Analyst with PT-BR prompts),
               5 action log entries

FILES CREATED (12 new, 1 modified):
  packages/db/src/schema/:
    custom-types.ts, enums.ts, organizations.ts, users.ts, projects.ts,
    agents.ts, action-logs.ts, approvals.ts, workflows.ts, documents.ts,
    strategies.ts
  packages/db/src/:
    seed.ts
  Modified:
    packages/db/src/schema/index.ts (barrel export updated)

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (4):
    1. projects.slug had no unique constraint → seed onConflictDoNothing silently failed
       → Added composite unique index (org_id, slug)
    2. Seed project used onConflictDoNothing (returns empty on conflict)
       → Changed to onConflictDoUpdate so .returning() always returns the row
    3. Agents inserted with plain insert (no upsert, duplicates on re-run)
       → Added unique (project_id, slug) + seed now uses onConflictDoUpdate
    4. Action logs inserted with plain insert (duplicates on re-run)
       → Added guard: check existing logs for project before inserting

  MEDIUM (3):
    5. workflow_node_runs missing project_id FK (every child table needs it for RLS)
       → Added project_id FK with cascade delete
    6. strategy_kpis missing createdAt timestamp (every other table has it)
       → Added createdAt with defaultNow()
    7. Redundant org_slug_idx index (slug already has .unique() which creates index)
       → Removed the redundant explicit index

  MINOR (1):
    8. users table missing updatedAt (mutable fields: role, locale, timezone)
       → Added updatedAt with $onUpdate

  ALSO FIXED DURING CODING (before review):
    - Missing jsonb import in approvals.ts
    - vector custom type fromDriver param typed as string instead of unknown
    - Duplicate vector type definition in agents.ts and documents.ts
      → Extracted to shared custom-types.ts

VERIFICATION:
  - turbo typecheck: 8/8 packages pass, zero type errors
  - Table count: 15 confirmed
  - Seed idempotency: org+user use onConflictDoUpdate, project uses onConflictDoUpdate
    with composite target, agents use onConflictDoUpdate, logs guarded with SELECT


================================================================================
COMMIT #3 — Epic P0-3: Redis & BullMQ Queue System
================================================================================
Hash:     f528052
Date:     2026-02-24 ~18:20 -0300
Tasks:    P0-3.1 through P0-3.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  packages/queue/src/:
    - connection.ts: BullMQ connection options factory (parses REDIS_URL,
      includes db index, enableReadyCheck, maxRetriesPerRequest)
    - jobs.ts: 7 Zod schemas for typed job payloads (AgentExecution,
      AgentScheduled, ToolExecution, EmbeddingGeneration, Notification,
      Analytics, Cleanup)
    - queues.ts: 7 BullMQ queue instances as lazy singletons with
      per-queue retry/backoff config + removeOnFail:false (dead letter)
    - index.ts: Barrel export (QUEUE_NAMES, getters, schemas, types)

  apps/worker/src/:
    - workers/create-worker.ts: Generic typed worker factory with
      Zod validation, error/completed/failed/stalled handlers
    - workers/*.worker.ts: 7 stub workers using factory pattern
    - index.ts: Express server + Bull Board (dev) + health endpoint
      + graceful shutdown with 30s timeout + global error handlers

  Queue architecture (7 queues):
    agent-execution:   concurrency=5,  retry=3x 30s exp backoff
    agent-scheduled:   concurrency=3,  retry=3x 30s exp backoff
    tool-execution:    concurrency=10, retry=5x 10s exp backoff
    embedding-generation: concurrency=3, retry=3x 15s exp backoff
    notification:      concurrency=5,  retry=5x 60s exp backoff
    analytics:         concurrency=1,  retry=3x 60s exp backoff
    cleanup:           concurrency=1,  retry=2x 120s exp backoff

FILES CREATED (11 new, 4 modified):
  New:
    packages/queue/src/connection.ts, jobs.ts, queues.ts
    apps/worker/src/workers/create-worker.ts
    apps/worker/src/workers/{agent-execution,agent-scheduled,tool-execution,
      embedding-generation,notification,analytics,cleanup}.worker.ts
    apps/worker/src/workers/index.ts
  Modified:
    packages/queue/src/index.ts, packages/queue/package.json
    apps/worker/src/index.ts, apps/worker/package.json, pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. Workers never validated job payloads with Zod at runtime
       → Created createTypedWorker factory with schema.parse() on every job
    2. getConnectionOptions() missing enableReadyCheck:false (race on reconnect)
       → Added to connection options
    3. createRedisConnection() was a footgun (unused but exported, leaked connections)
       → Removed entirely, only getConnectionOptions() remains

  HIGH (2):
    4. Graceful shutdown could hang indefinitely (no timeout)
       → Added 30s hard-exit timeout + server.closeAllConnections()
    5. getConnectionOptions() dropped Redis db index from URL path
       → Added db: Number(parsed.pathname.slice(1)) parsing

  MEDIUM (1):
    6. No error event handlers on workers (could crash process)
       → Added worker.on('error') in the factory

  LOW (3) — also fixed:
    7. No unhandledRejection/uncaughtException handlers → Added
    8. 7 worker files were 250+ lines of boilerplate → Extracted factory (30 lines)
    9. Unused socket.io dep in worker → Removed (will add in P0-9)
    10. Unused @ai-office/shared dep in queue package → Removed

  ALSO FIXED DURING CODING (before review):
    - Missing zod dep in packages/queue/package.json
    - ioredis import: default vs named export issue with NodeNext resolution
      → Used named import { Redis } from 'ioredis'
    - bull-board adapter import path: .js extension not in exports map
      → Removed .js suffix
    - bullmq needed as direct dep in worker (Worker class import)

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - pnpm install: zero errors across all workspaces
  - All 7 queues match roadmap concurrency and retry specs
  - All 7 workers validate payloads with Zod before processing


================================================================================
COMMIT #5 — Epic P0-4: CI/CD Pipeline — GitHub Actions, Vercel, Railway
================================================================================
Hash:     bec2cb2
Date:     2026-02-24 ~19:30 -0300
Tasks:    P0-4.1 through P0-4.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  .github/workflows/ci.yml:
    - Triggers: pull_request + push to main/develop + workflow_call (reusable)
    - Node.js matrix: 20, 22
    - Services: pgvector/pgvector:pg16 + redis:7-alpine with health checks
    - Steps: checkout → pnpm 9 → Node.js → install → lint → typecheck → test → build
    - Concurrency: cancel-in-progress per ref
    - timeout-minutes: 15

  .github/workflows/deploy-staging.yml:
    - Trigger: push to develop
    - Job graph: ci (gate) → migrate-db → deploy-web + deploy-worker (parallel)
    - cancel-in-progress: false (prevents partial deploys)
    - Web: Vercel (preview environment)
    - Worker: Railway CLI (staging environment)

  .github/workflows/deploy-production.yml:
    - Trigger: push to main
    - Job graph: ci (gate) → migrate-db → deploy-web + deploy-worker (parallel)
    - cancel-in-progress: false
    - Web: Vercel (production environment, --prod flag)
    - Worker: Railway CLI (production environment)

  vercel.json:
    - Framework: nextjs
    - installCommand: pnpm install --frozen-lockfile
    - buildCommand: pnpm turbo build --filter=web
    - No rootDirectory (runs from repo root for monorepo compat)

  apps/worker/Dockerfile:
    - Multi-stage build (builder + runner)
    - Base: node:20-alpine
    - Copies ALL workspace package.json files (pnpm lockfile requirement)
    - Build: pnpm turbo build --filter=worker...
    - Prune: pnpm prune --prod (in builder, before copy to runner)
    - Non-root user: worker (uid 1001)
    - HEALTHCHECK: wget http://localhost:4000/health every 30s
    - Exposes port 4000

  .dockerignore:
    - Excludes: node_modules, .git, .github, .turbo, .next, .env*, *.md,
      dist, coverage, .vscode, .idea
    - Allows: .env.example

FILES CREATED (6 new):
  .github/workflows/ci.yml
  .github/workflows/deploy-staging.yml
  .github/workflows/deploy-production.yml
  vercel.json
  apps/worker/Dockerfile
  .dockerignore

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (3):
    1. ci.yml missing workflow_call trigger → production deploy referenced it as
       reusable workflow but it had no workflow_call trigger → Added
    2. Dockerfile missing packages/api and apps/web package.json → pnpm
       --frozen-lockfile fails when workspace packages are absent → Added ALL
       workspace package.json files
    3. deploy-web ran in parallel with migrate-db (web could deploy before
       migrations) → Changed deploy-web needs to [ci, migrate-db]

  HIGH (5):
    4. Staging deploy had no CI gate → Added ci job using workflow_call
    5. Staging deploy was missing database migrations → Added migrate-db job
    6. Dockerfile ran as root → Added non-root user (worker, uid 1001)
    7. Dockerfile copied full node_modules with devDeps to runner → Added
       pnpm prune --prod in builder stage before copy
    8. vercel.json buildCommand used fragile "cd ../.. &&" path → Changed to
       root-relative "pnpm turbo build --filter=web", removed rootDirectory

  MEDIUM (2):
    9. Staging cancel-in-progress:true could leave partial deploys → Changed
       to false (matches production)
    10. No timeout on CI job (default 6h) → Added timeout-minutes: 15

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - All 3 workflows have correct job dependency graphs
  - Dockerfile includes all 10 workspace package.json files
  - Non-root user configured in runner stage


================================================================================
COMMIT #7 — Epic P0-5: Authentication & Multi-Tenancy (Clerk)
================================================================================
Hash:     c424e05
Date:     2026-02-24 ~20:15 -0300
Tasks:    P0-5.1 through P0-5.5 (5 tasks)
================================================================================

WHAT WAS BUILT:
  apps/web/src/middleware.ts:
    - Clerk middleware with clerkMiddleware() + createRouteMatcher
    - Public routes: /, /sign-in, /sign-up, /:locale/sign-in, /:locale/sign-up,
      /api/webhooks
    - All other routes require authentication

  apps/web/src/app/layout.tsx:
    - Wrapped with ClerkProvider
    - IBM Plex Mono font, dark theme globals.css

  apps/web/src/app/(public)/sign-in/[[...sign-in]]/page.tsx:
    - Clerk SignIn component with dark theme appearance overrides

  apps/web/src/app/(public)/sign-up/[[...sign-up]]/page.tsx:
    - Clerk SignUp component with dark theme appearance overrides

  apps/web/src/app/api/webhooks/clerk/route.ts:
    - Svix webhook signature verification (uses raw body text)
    - user.created: creates personal org (slug: personal-{clerkId}),
      default project, user (idempotent with onConflictDoUpdate)
    - user.updated: syncs email, name, avatar
    - user.deleted: removes user + cleans up orphaned org if no members
    - organization.created: upserts org by clerkOrgId, creates default project
    - organizationMembership.created: updates user orgId + maps Clerk role
      (org:admin→admin, org:member→viewer)

  apps/web/src/stores/project-store.ts:
    - Zustand store with persist middleware (skipHydration for SSR)
    - State: currentOrgId, currentProjectId, userRole, organizations, projects
    - Selectors: useActiveProject(), useProjects(), useUserRole(), useActiveOrg()
    - Only currentOrgId + currentProjectId persisted to localStorage

  packages/api/src/trpc.ts:
    - createTRPCContext: accepts clerkUserId + projectId, looks up user/org/project
    - publicProcedure: no auth required
    - protectedProcedure: requires auth + org (narrows both to non-null)
    - projectProcedure: requires auth + org + project, sets RLS session var
      via parameterized SQL: set_config('app.current_project_id', $1, true)
    - requireRole(minimumRole): middleware factory with hierarchy
      viewer(0) < manager(1) < admin(2) < owner(3)
    - adminProcedure: projectProcedure + requireRole('admin')
    - ownerProcedure: projectProcedure + requireRole('owner')

FILES CREATED (5 new, 7 modified):
  New:
    apps/web/src/middleware.ts
    apps/web/src/app/(public)/sign-in/[[...sign-in]]/page.tsx
    apps/web/src/app/(public)/sign-up/[[...sign-up]]/page.tsx
    apps/web/src/app/api/webhooks/clerk/route.ts
    apps/web/src/stores/project-store.ts
  Modified:
    apps/web/src/app/layout.tsx (added ClerkProvider)
    apps/web/package.json (added @clerk/nextjs, svix, drizzle-orm)
    packages/api/src/trpc.ts (full rewrite with auth context)
    packages/api/src/index.ts (new exports)
    packages/api/package.json (added drizzle-orm, @types/node)
    .env.example (added CLERK_WEBHOOK_SECRET, after sign-in/up URLs)
    pnpm-lock.yaml

REVIEW — ISSUES FOUND AND FIXED BEFORE COMMIT:
  CRITICAL (1):
    1. SQL injection in RLS set_config via string interpolation
       → Changed to parameterized query using drizzle-orm sql tag

  HIGH (4):
    2. Webhook body re-serialization (JSON.parse→JSON.stringify) could break
       svix signature verification → Changed to req.text() for raw body
    3. user.created handler not idempotent — plain INSERT without conflict
       handling caused failures on webhook replay → Added onConflictDoUpdate
    4. organization.created used clerkOrgId as conflict target but slug
       collision would throw unhandled error → Wrapped in try/catch
    5. organizationMembership.created did not map Clerk role, kept old role
       (privilege escalation risk) → Added role mapping (org:admin→admin,
       org:member→viewer)

  MEDIUM (5):
    6. Webhook threw raw Error on missing CLERK_WEBHOOK_SECRET → Changed to
       console.error + HTTP 500 response
    7. Org slug from email prefix could collide across domains → Changed to
       personal-{clerkId} format
    8. Zustand persist caused SSR hydration mismatch → Added skipHydration:true
    9. Middleware public routes didn't account for locale-prefixed paths
       → Added /:locale/sign-in and /:locale/sign-up patterns
    10. enforceAuth middleware did not narrow org to non-null → Added org
        null check with INTERNAL_SERVER_ERROR

  ALSO FIXED DURING CODING:
    - Missing @types/node in packages/api (needed for process.env in db client)
    - Missing drizzle-orm in web app (needed for eq() in webhook handler)
    - undici-types inference error on POST handler → Added explicit
      Promise<Response> return type
    - Role mapping type mismatch (string vs enum) → Used typed roleMap
      with UserRole type alias

VERIFICATION:
  - turbo typecheck --force: 8/8 packages pass, zero type errors
  - Webhook handler fully idempotent for all 5 event types
  - RLS set_config uses parameterized SQL (no injection risk)
  - Role hierarchy: viewer(0) < manager(1) < admin(2) < owner(3)


================================================================================
